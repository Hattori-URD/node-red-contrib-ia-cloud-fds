<script type="text/x-red" data-template-name="EnOcean-com">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="node-red:common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]node-red:common.label.name">
    </div>
    <div class="form-row node-input-serial">
        <label for="node-input-serial"><i class="fa fa-random"></i> <span data-i18n="serial.label.serialport"></span></label>
        <input type="text" id="node-input-serial">
    </div>
    <div class="form-row">
        <label for="node-input-linkdataobj"><i class="fa fa-random"></i> <span data-i18n="serial.label.linkObjName"></span></label>
        <input type="text" id="node-input-linkdataobj">
    </div>
</script>

<script type="text/x-red" data-help-name="EnOcean-com" charset="utf-8">
    <p>シリアルポートからEnOceanデータを読み込み各センサーのデータを内部に保存します</p>
    <p>このノードを使うにはUSBポートにEnOceanドングルを差し込む必要があります。</p>
    <p>このノードは各種のEnOcean通信をサポートしたセンサデバイスからEnOcean通信を受信し各センサIDごとのESP電文を設定ノードであるenOceanLinkObjに格納します</p>
    <p>受信するデータは下記のいずれかを指定可能 <ul>
    <li>区切り文字を待つ(デフォルトは \n)。区切り文字は16進表記(0x0d)の指定も可。</li>
    <li>最初の文字を受信してからミリ秒単位のタイムアウトを待つ。</li>
    <li>一定サイズのバッファを満たすまで待つ。</li></ul></p>
</script>

<script type="text/javascript">
    RED.nodes.registerType('EnOcean-com',{
        category: 'iaCloud',
        defaults: {
            name: {name:""},
            serial: {type:"serial-port",required:true},
            linkdataobj: {type:"link-data-object", required:true, value:""}
        },
        color:"#3FADB5",
        inputs:0,
        outputs:1,
        icon: "bridge.png",
        label: function() {
            var serialNode = RED.nodes.node(this.serial);
            return this.name||(serialNode?serialNode.label().split(":")[0]:this._("serial.label.serial"));
        },
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        }
    });
</script>

<!-- EnOcean-object Node の記述 -->
<script type="text/x-red" data-template-name="EnOcean-obj">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="node-red:common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]node-red:common.label.name">
    </div>
    <div class="form-row">
        <label for="node-input-sensor_kind"><i class="fa fa-thermometer-half"></i> <span data-i18n="serial.label.sensor_kind"></span></label>
        <select type="text" id="node-input-sensor_kind">
            <option value="u-rd">電流センサー(U-RD)</option>
            <option value="watty">温度センサー(Watty)</option>
        </select>
    </div>
    <div class="form-row">
        <label for="node-input-sensor_id"><i class="fa fa-flag"></i> <span data-i18n="serial.label.sensor_id"></span></label>
        <input type="text" id="node-input-sensor_id" data-i18n="serial.label.sensor_id">
    </div>
    <div class="form-row">
        <label for="node-input-linkdataobj"><i class="fa fa-random"></i> <span data-i18n="serial.label.linkObjName"></span></label>
        <input type="text" id="node-input-linkdataobj">
    </div>
    <div class="form-row">
        <label for="node-input-collectdataobj"><i class="fa fa-random"></i> <span data-i18n="serial.label.collectDataObjName"></span></label>
        <input type="text" id="node-input-collectdataobj">
    </div>
</script>

<script type="text/x-red" data-help-name="EnOcean-obj" charset="utf-8">
    <p>一定周期あるいは非同期にia-cloudオブジェクトを生成して出力します</p>
</script>

<script type="text/javascript">
    RED.nodes.registerType('EnOcean-obj',{
        category: 'iaCloud',
        defaults: {
            name: {name:""},
            sensor_kind: {value:"ur-d", required:true},
            sensor_id: {value:"", required:true},
            linkdataobj: {type:"link-data-object", required:true, value:""},
            collectdataobj: {type:"collect-data-object", required:true, value:""}
        },
        color:"#C7E9C0",
        inputs:1,
        outputs:1,
        icon: "swap.png",
        label: function() {
            return this.name || "EnOcean Object";
        },
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        }
    });
</script>

<!-- collect-data-object Config Node の記述 -->
<script type="text/x-red" data-template-name="collect-data-object">
    <div class="form-row">
        <label for="node-config-input-object_key"><i class="fa fa-flag"></i> <span data-i18n="collect.label.object_key"></span></label>
        <input type="text" id="node-config-input-object_key" data-i18n="collect.label.name">
    </div>
    <div class="form-row">
        <label for="node-config-input-object_desc"><i class="fa fa-tag"></i> <span data-i18n="collect.label.object_desc"></span></label>
        <input type="text" id="node-config-input-object_desc" data-i18n="collect.label.object_desc">
    </div>
    <div class="form-row">
        <table width="100%">
        <tr id="entry_1">
            <td>
                <label for="node-config-input-dataname_1"><i class="fa fa-tag"></i> <span data-i18n="collect.label.dataname"></span></label>
                <input type="text" id="node-config-input-dataname_1">
            </td>
        </tr>
        <tr id="entry_2">
            <td>
                <label for="node-config-input-dataname_2"><i class="fa fa-tag"></i> <span data-i18n="collect.label.dataname"></span></label>
                <input type="text" id="node-config-input-dataname_2">
            </td>
        </tr>
        <tr id="entry_3">
            <td>
                <label for="node-config-input-dataname_3"><i class="fa fa-tag"></i> <span data-i18n="collect.label.dataname"></span></label>
                <input type="text" id="node-config-input-dataname_3">
            </td>
        </tr>
        <tr id="entry_4">
            <td>
                <label for="node-config-input-dataname_4"><i class="fa fa-tag"></i> <span data-i18n="collect.label.dataname"></span></label>
                <input type="text" id="node-config-input-dataname_4">
            </td>
        </tr>
        </table>
    </div>
</script>

<script type="text/x-red" data-help-name="collect-data-object" charset="utf-8">
    <p>ia-cloudオブジェクトの情報を設定するノードです。ここでクラウドに通知する必要な情報を設定します。</p>
</script>

<script type="text/javascript">
    RED.nodes.registerType('collect-data-object',{
        category: 'config',
        defaults: {
            object_key: {value:""},
            object_desc: {value:""},
            dataname_1: {value:""},
            dataname_2: {value:""},
            dataname_3: {value:""},
            dataname_4: {value:""}
        },
        label: function() {
            return this.object_key||("CollectDataObject");
        }
    });
</script>

<!-- link-data-object Config Node の記述 -->
<script type="text/x-red" data-template-name="link-data-object">
    <div class="form-row">
        <label for="node-config-input-name"><i class="fa fa-tag"></i> <span data-i18n="serial.label.objectName"></label>
        <input type="text" id="node-config-input-name">
    </div>
    <div class="form-row">
        <label for="node-config-input-entry_sensor"><i class="fa fa-flag"></i> <span data-i18n="serial.label.entryID"></label>
        <input type="text" id="node-config-input-entry_sensor" style="width:50%;">
        <a id="node-config-input-entry_sensor" class="btn"><i id="node-config-input-addbtn">追加</i></a>
    </div>
    <div class="form-row">
        <table width="100%"><tr>
            <td width="150px"><span data-i18n="serial.label.sensor_id"></span></td>
            <td width="100px" data-i18n="serial.label.notify"></td>
            <td width="80px"></td>
        </tr>
        <tr id="entry_1">
        <td><input type="text" id="node-config-input-sensor_1"></td>
        <td>
        <select type="text" id="node-config-input-notify_1" style="width:90%;">
            <option value="true">true</option>
            <option value="false">false</option>
        </select>
        </td>
        <td><input type="button" id="node-config-input-delete_1" data-n="1" value="削除"></td>
        </tr>
        <tr id="entry_2">
        <td><input type="text" id="node-config-input-sensor_2"></td>
        <td>
        <select type="text" id="node-config-input-notify_2" style="width:90%;">
            <option value="true">true</option>
            <option value="false">false</option>
        </select>
        </td>
        <td><input type="button" id="node-config-input-delete_2" data-n="2" value="削除"></td>
        </tr>
        <tr id="entry_3">
        <td><input type="text" id="node-config-input-sensor_3"></td>
        <td>
        <select type="text" id="node-config-input-notify_3" style="width:90%;">
            <option value="true">true</option>
            <option value="false">false</option>
        </select>
        </td>
        <td><input type="button" id="node-config-input-delete_3" data-n="3" value="削除"></td>
        </tr>
        <tr id="entry_4">
        <td><input type="text" id="node-config-input-sensor_4"></td>
        <td>
        <select type="text" id="node-config-input-notify_4" style="width:90%;">
            <option value="true">true</option>
            <option value="false">false</option>
        </select>
        </td>
        <td><input type="button" id="node-config-input-delete_4" data-n="4" value="削除"></td>
        </tr>
        <tr id="entry_5">
        <td><input type="text" id="node-config-input-sensor_5"></td>
        <td>
        <select type="text" id="node-config-input-notify_5" style="width:90%;">
            <option value="true">true</option>
            <option value="false">false</option>
        </select>
        </td>
        <td><input type="button" id="node-config-input-delete_5" data-n="5" value="削除"></td>
        </tr>
        <tr id="entry_6">
        <td><input type="text" id="node-config-input-sensor_6"></td>
        <td>
        <select type="text" id="node-config-input-notify_6" style="width:90%;">
            <option value="true">true</option>
            <option value="false">false</option>
        </select>
        </td>
        <td><input type="button" id="node-config-input-delete_6" data-n="6" value="削除"></td>
        </tr>
        <tr id="entry_7">
        <td><input type="text" id="node-config-input-sensor_7"></td>
        <td>
        <select type="text" id="node-config-input-notify_7" style="width:90%;">
            <option value="true">true</option>
            <option value="false">false</option>
        </select>
        </td>
        <td><input type="button" id="node-config-input-delete_7" data-n="7" value="削除"></td>
        </tr>
        <tr id="entry_8">
        <td><input type="text" id="node-config-input-sensor_8"></td>
        <td>
        <select type="text" id="node-config-input-notify_8" style="width:90%;">
            <option value="true">true</option>
            <option value="false">false</option>
        </select>
        </td>
        <td><input type="button" id="node-config-input-delete_8" data-n="8" value="削除"></td>
        </tr>
        <tr id="entry_9">
        <td><input type="text" id="node-config-input-sensor_9"></td>
        <td>
        <select type="text" id="node-config-input-notify_9" style="width:90%;">
            <option value="true">true</option>
            <option value="false">false</option>
        </select>
        </td>
        <td><input type="button" id="node-config-input-delete_9" data-n="9" value="削除"></td>
        </tr>
        <tr id="entry_10">
        <td><input type="text" id="node-config-input-sensor_10"></td>
        <td>
        <select type="text" id="node-config-input-notify_10" style="width:90%;">
            <option value="true">true</option>
            <option value="false">false</option>
        </select>
        </td>
        <td><input type="button" id="node-config-input-delete_10" data-n="10" value="削除"></td>
        </tr>
        </table>
    </div>
</script>

<script type="text/x-red" data-help-name="link-data-object" charset="utf-8">
    <p>EnOcean機器オブジェクトノードの設定ノードです。センサーID毎の通知有無を変更できます。</p>
</script>

<script type="text/javascript">
    RED.nodes.registerType('link-data-object',{
        category: 'config',
        defaults: {
            name: {value:""},
            entry_sensor: {value:""},
            sensor_1: {value:""},
            notify_1: {value:"false"},
            sensor_2: {value:""},
            notify_2: {value:"false"},
            sensor_3: {value:""},
            notify_3: {value:"false"},
            sensor_4: {value:""},
            notify_4: {value:"false"},
            sensor_5: {value:""},
            notify_5: {value:"false"},
            sensor_6: {value:""},
            notify_6: {value:"false"},
            sensor_7: {value:""},
            notify_7: {value:"false"},
            sensor_8: {value:""},
            notify_8: {value:"false"},
            sensor_9: {value:""},
            notify_9: {value:"false"},
            sensor_10: {value:""},
            notify_10: {value:"false"}
        },
        label: function() {
            return this.name||("enOceanLinkObj");
        },
        oneditprepare: function() {
            var notify_list = ["1", "2", "3", "4", "5", "6", "7", "8", "9", "10"];
            var tr_prefix = "#entry_";
            var sensor_prefix = "#node-config-input-sensor_";
            var notify_prefix = "#node-config-input-notify_";
            $.each(notify_list, function(index, value) {
                var tr_id = tr_prefix + value;
                var sensor_id = sensor_prefix + value;
                var notify_id = notify_prefix + value;
                if ($(sensor_id).val() == "") {
                    $(tr_id).hide();
                } else {
                    $(tr_id).show();
                }
            });
            
            //$("#node-config-input-entry_sensor").on('focus', function() {
            //    $("#node-config-input-entry_sensor").val('04009EFC');
            //});
            addRow = function(sensor_id) {
                var counter = 0;
                $("[id^='node-config-input-sensor_']").each(function(){
                   var index = $(this).attr("id").replace("node-config-input-sensor_", "");
                   var tr_id = "#entry_" + index;
                   counter++;
                   if ($(this).val() == "") {
                       $(tr_id).show();
                       $(this).val(sensor_id);
                       return false;
                   }
                });
            }
            $("#node-config-input-addbtn").click(function() {
                //addRow();
                $("#node-config-input-addbtn").addClass('disabled');
                var sensor_id = $("#node-config-input-entry_sensor").val();
                addRow(sensor_id);
                
                //$.getJSON('endata',function(data) {
                //    $("#node-config-input-addbtn").removeClass('disabled');
                //    var endata = "";
                //    $.each(data, function(key, value) {
                //        endata = value;
                //    });
                //    $("#node-config-input-value").val(endata);
                //});
            });
            // $('#table1').on('click', 'tr', function(event){$(this).remove();});
            $("[id^='node-config-input-delete_']").click(function() {
                var index = $(this).data("n");
                var delete_tr = tr_prefix + index;
                var sensor_id = sensor_prefix + index;
                var notify_id = notify_prefix + index;
                $(delete_tr).hide();
            });
            
            $("#node-config-input-name").val(this.name);
            $("#node-config-input-value").on('focus', function() {
                $("#node-config-input-value").val('focus');
            });
        },
        oneditsave: function() {
            if ($("#node-config-input-name").val() == "") {
                this.name = "enOceanLinkObj";
            } else {
                this.name = $("#node-config-input-name").val();
            }
        }
    });
</script>

<script type="text/x-red" data-template-name="serial-port">
    <div class="form-row">
        <label for="node-config-input-serialport"><i class="fa fa-random"></i> <span data-i18n="serial.label.serialport"></span></label>
        <input type="text" id="node-config-input-serialport" style="width:66%;" data-i18n="[placeholder]serial.placeholder.serialport">
        <a id="node-config-lookup-serial" class="btn"><i id="node-config-lookup-serial-icon" class="fa fa-search"></i></a>
    </div>
    <div class="form-row">
        <table width="100%"><tr>
            <td width="100px"><i class="fa fa-wrench"></i> <span data-i18n="serial.label.settings"></span></td>
            <td width="110px" data-i18n="serial.label.baudrate"></td>
            <td width="70px" data-i18n="serial.label.databits"></td>
            <td width="80px" data-i18n="serial.label.parity"></td>
            <td width="70px" data-i18n="serial.label.stopbits"></td>
        </tr><tr><td>&nbsp;</td>
        <td>
            <input type="text" id="node-config-input-serialbaud" style="width:92%">
        </td><td>
        <select type="text" id="node-config-input-databits" style="width:90%;">
            <option value="8">8</option>
            <option value="7">7</option>
            <option value="6">6</option>
            <option value="5">5</option>
        </select>
        </td><td>
        <select type="text" id="node-config-input-parity" style="width:90%;">
            <option value="none" data-i18n="serial.parity.none"></option>
            <option value="even" data-i18n="serial.parity.even"></option>
            <option value="mark" data-i18n="serial.parity.mark"></option>
            <option value="odd" data-i18n="serial.parity.odd"></option>
            <option value="space" data-i18n="serial.parity.space"></option>
        </select>
        </td><td>
        <select type="text" id="node-config-input-stopbits" style="width:90%;">
            <option value="2">2</option>
            <option value="1">1</option>
        </select>
        </td></tr></table>
    </div>
    <br/>
    <div class="form-row">
        <label><i class="fa fa-sign-in"></i> <span data-i18n="serial.label.input"></span></label>
    </div>
    <div class="form-row" style="padding-left:10px;">
        <span data-i18n="serial.label.split"></span>
        <select type="text" id="node-config-input-out" style="margin-left:5px; width:200px;">
            <option value="char" data-i18n="serial.split.character"></option>
            <option value="time" data-i18n="serial.split.timeout"></option>
            <option value="interbyte" data-i18n="serial.split.silent"></option>
            <option value="count" data-i18n="serial.split.lengths"></option>
        </select>
        <input type="text" id="node-config-input-newline" style="width:50px;">
        <span id="node-units"></span>
    </div>
    <div class="form-row" style="padding-left:10px;">
        <span data-i18n="serial.label.deliver"></span>
        <select type="text" id="node-config-input-bin" style="margin-left:5px; width:150px;">
            <option value="false" data-i18n="serial.output.ascii"></option>
            <option value="bin" data-i18n="serial.output.binary"></option>
        </select>
    </div>
    <br/>
<!--
    <div id="node-config-addchar">
        <div class="form-row">
            <label><i class="fa fa-sign-out"></i> <span data-i18n="serial.label.output"></span></label>
        </div>
        <div class="form-row">
            <input style="width:30px; margin-left:10px; vertical-align:top;" type="checkbox" id="node-config-input-addchar"><label style="width:auto;" for="node-config-input-addchar"><span data-i18n="serial.addsplit"></span></label>
        </div>
    </div>
    <br/>
    <div id="node-config-addchar">
        <div class="form-row">
            <label><i class="fa fa-exchange"></i> <span data-i18n="serial.label.request"></span></label>
        </div>
        <div class="form-row" style="padding-left:10px;">
            <span data-i18n="serial.label.responsetimeout"></span>
            <input type="text" id="node-config-input-responsetimeout" style="width:60px;">
            <span data-i18n="serial.label.ms"></span>
        </div>
    </div>
    <div class="form-tips" id="tip-responsetimeout" hidden><span data-i18n="serial.tip.responsetimeout"></span></div>
-->
    <div class="form-tips" id="tip-split"><span data-i18n="serial.tip.split"></span></div>
    <div class="form-tips" id="tip-timeout" hidden><span data-i18n="serial.tip.timeout"></span></div>
    <div class="form-tips" id="tip-silent" hidden><span data-i18n="serial.tip.silent"></span></div>
</script>

<script type="text/x-red" data-help-name="serial-port" charset="utf-8">
    <p>本画面ではシリアルポートに対する設定オプションを提供します</p>
    <p>検索ボタンを押すことによって選択可能な有効なシリアルポートの一覧を表示します。もしくはポート名が既知ならばそのパスを指定することができます。</p>
    <p>入力データは固定文字列、もしくはタイムアウト秒数、固定文字数で区切って受信する設定ができます。</p>
    <p>文字を指定するときは文字そのもの、エスケープ文字列（\nなど)、16進コード(0x0dなど)を指定することができます。</p>
    <p>【注記】本ノードはシリアルポートノードの設定ノードを流用しています。</p>
</script>

<script type="text/javascript">
    RED.nodes.registerType('serial-port',{
        category: 'config',
        defaults: {
            //name: {value:""},
            serialport: {value:"",required:true},
            serialbaud: {value:"57600",required:true,validate:RED.validators.number()},
            databits: {value:8,required:true},
            parity: {value:"none",required:true},
            stopbits: {value:1,required:true},
            newline: {value:"\\n"},
            bin: {value:"false"},
            out: {value:"char"},
            addchar: {value:false},
            responsetimeout: {value: 10000}
        },
        label: function() {
            this.serialbaud = this.serialbaud || 57600;
            this.databits = this.databits || 8;
            this.parity = this.parity || this._("serial.label.none");
            this.stopbits = this.stopbits || 1;
            return this.serialport+":"+this.serialbaud+"-"+this.databits+this.parity.charAt(0).toUpperCase()+this.stopbits;
        },
        oneditprepare: function() {
            var previous = null;
            var blist = [
                {value:"115200",label:"115200",hasValue:false},
                {value:"57600",label:"57600",hasValue:false},
                {value:"38400",label:"38400",hasValue:false},
                {value:"19200",label:"19200",hasValue:false},
                {value:"9600",label:"9600",hasValue:false},
                {value:"4800",label:"4800",hasValue:false},
                {value:"2400",label:"2400",hasValue:false},
                {value:"1200",label:"1200",hasValue:false},
                {value:"600",label:"600",hasValue:false},
                {value:"300",label:"300",hasValue:false},
                {label:"other",value:"other",icon:"red/images/typedInput/09.png",validate:/^[0-9]*$/}
            ];

            var serialbaudType = "custom";
            for (var i in blist) {
                if (this.serialbaud == blist[i].value) {
                    serialbaudType = this.serialbaud;
                }
            }

            $("#node-config-input-serialbaud").typedInput({
                default: this.serialbaud,
                types:blist
            });

            $("#node-config-input-out").on('focus', function () { previous = this.value; }).change(function() {
                if (previous == null) { previous = $("#node-config-input-out").val(); }
                if ($("#node-config-input-out").val() == "char") {
                    if (previous != "char") { $("#node-config-input-newline").val("\\n"); }
                    $("#node-units").text("");
                    //$("#node-config-addchar").show();
                    $("#tip-split").show();
                    $("#tip-timeout").hide();
                    $("#tip-silent").hide();
                }
                else if ($("#node-config-input-out").val() == "time") {
                    if (previous != "time") { $("#node-config-input-newline").val("0"); }
                    $("#node-units").text("ms");
                    $("#node-config-addchar").hide();
                    //$("#node-config-input-addchar").val("false");
                    $("#tip-split").hide();
                    $("#tip-timeout").show();
                    $("#tip-silent").hide();
                }
                else if ($("#node-config-input-out").val() == "interbyte") {
                    if (previous != "interbyte") { $("#node-config-input-newline").val("0"); }
                    $("#node-units").text("ms");
                    $("#node-config-addchar").hide();
                    //$("#node-config-input-addchar").val("false");
                    $("#tip-split").hide();
                    $("#tip-timeout").hide();
                    $("#tip-silent").show();
                }
                else {
                    if (previous != "count") { $("#node-config-input-newline").val(""); }
                    $("#node-units").text("chars");
                    $("#node-config-addchar").hide();
                    //$("#node-config-input-addchar").val("false");
                    $("#tip-split").hide();
                    $("#tip-timeout").hide();
                    $("#tip-silent").hide();
                }
            });

            //$("#node-config-input-responsetimeout").on('focus', function () { $("#tip-responsetimeout").show(); });

            try {
                $("#node-config-input-serialport").autocomplete( "destroy" );
            } catch(err) {
            }
            $("#node-config-lookup-serial").click(function() {
                $("#node-config-lookup-serial").addClass('disabled');
                $.getJSON('serialports',function(data) {
                    $("#node-config-lookup-serial").removeClass('disabled');
                    var ports = [];
                    $.each(data, function(i, port) {
                        ports.push(port.comName);
                    });
                    $("#node-config-input-serialport").autocomplete({
                        source:ports,
                        minLength:0,
                        close: function( event, ui ) {
                            $("#node-config-input-serialport").autocomplete( "destroy" );
                        }
                    }).autocomplete("search","");
                });
            });
        },
        oneditsave: function() {
            var mytype = $("#node-config-input-serialbaud").typedInput('type');
            if (mytype !== "other") {
                $("#node-config-input-serialbaud").typedInput('value',mytype);
            }
            this.serialbaud = $("#node-config-input-serialbaud").typedInput('value');
        }
    });
</script>
