<!--
  Copyright JS Foundation and other contributors, http://js.foundation
  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at
  http://www.apache.org/licenses/LICENSE-2.0
  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/x-red" data-template-name="Modbus-dItems">

    <div class="form-row">
      <div class="form-row">
          <label for="node-config-input-name">
              <i class="fa fa-tag"></i>i_Node name</label>
          <input type="text" id="node-config-input-name">
      </div>
      <div class="form-row hidden">
          <input type="text" id="node-config-input-configObject">
          <input type="text" id="node-config-input-configReady">
      </div>
      <div class="form-row">
        <label for="node-config-input-contentType"><i class="fa fa-tag"></i>
            i_データ型<span style="color: #ff0000;">*</span></label>
        <input type="text" id="node-config-input-contentType" autocomplete="on" >
      </div>
    </div>
    <div id="blocks">
        <div class="form-block" id="form_block[0]">
            <div class="form-row">
              <div class="form-inline" id="from_del[0]" >
                <span style="border-bottom:solid 2px;">i_データ項目 :</span>
                <input type="text" id="dItem[0]" style="width: 30px;" value="1"
                    disabled="disabled">
                <select style="width: 150px; margin-left: 30px;" name="dataType[0]"
                    id="dataType[0]">
                    <option selected="selected" value="bit">i_ビット型</option>
                    <option value="number">i_数値型</option>
                    <option value="string">i_文字列型</option>
                    <option value="numList">i_数値列型</option>
                </select>
                <input type="button" name="del_btn" value="i_削除"
                    style="margin-left: 30px; width: 70px; display: none;">
                </div>
            </div>
            <div class="form-row" id="block-bit[0]" name="bit" style="margin-left: 10px;">
                <div class="form-row">
                    <div class="form-inline" style="vertical-align: middle;" >
                        <label>i_データ名称<span style="color: #ff0000;">*</span></label>
                        <input type="text" style="width: 150px;" id="bit-dName[0]">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-inline" style="vertical-align: middle;">
                        <label>i_先頭アドレス<span style="color: #ff0000;">*</span></label>
                        <select id="bit-deviceType[0]" style="width: 50px;">
                            <option selected="selected"　value="Coil">Coil</option>
                            <option value="IS">IS</option>
                        </select>
                        <input type="text" style="margin-right: 10px; width: 150px"
                            id="bit-src[0]">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-inline" style="vertical-align: middle;">
                        <label>i_ビット数<span style="color: #ff0000;">*</span></label>
                        <input type="number" min="1" style="margin-right: 10px; width: 50px"
                            id="bit-num[0]" value="1">
                        <select style="width: 70px" id="bit-logic[0]">
                            <option selected="selected"　value= "pos">正論理</option>
                            <option value= "neg">負論理</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="form-row hidden" id="block-number[0]" name="number"
                    style="margin-left: 10px;">
                <div class="form-row">
                    <div class="form-inline" style="vertical-align: middle;" >
                        <label>i_データ名称<span style="color: #ff0000;">*</span></label>
                        <input type="text" style="width: 150px; margin-right: 20px;"
                            id="number-dName[0]">
                        <label>i_単位</label>
                        <input type="text" style="width: 50px; margin-right: 10px;"
                            id="number-unit[0]">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-row">
                        <div class="form-inline" style="vertical-align: middle;">
                            <label>i_先頭アドレス<span style="color: #ff0000;">*</span></label>
                            <select id="number-deviceType[0]" style="width: 50px;">
                                <option selected="selected" value="IR">IR</option>
                                <option value="HR">HR</option>
                            </select>
                            <input type="text" style="width: 120px; margin-right: 10px;"
                                id="number-src[0]">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-inline" style="vertical-align: middle;">
                            <label>i_データ型</label>
                            <select id="number-type[0]" style="width: 100px;">
                                <option selected="selected"　value="Word">ワード</option>
                                <option value="dWord">倍ワード</option>
                                <option value="BCD">BCD</option>
                                <option value="dBCD">倍BCD</option>
                            </select>
                            <label style="width:50px; margin-left: 10px;">i_ゼロ</label>
                            <input type="number" style="width: 50px; margin-right: 10px;"
                                id="numbe-offset[0]" value="0">
                            <label style="width:50px;">i_倍率</label>
                            <input type="number" style="width: 50px;"
                                id="number-gain[0]" value="1">
                        </div>
                    </div>
                </div>
            </div>
            <div class="form-row hidden" id="block-string[0]" name="string"
                    style="margin-left: 10px;">
                <div class="form-row">
                    <div class="form-inline" style="vertical-align: middle;" >
                        <label>i_データ名称<span style="color: #ff0000;">*</span></label>
                        <input type="text" style="width: 150px" id="string-dName[0]">
                        <select id="string-encode[0]"
                            style="width: 100px; margin-right: 10px;">
                            <option value="sJIS">シフトJIS</option>
                            <option selected="selected"　value="utf-8">UTF-8</option>
                            <option value="EUC">EUC</option>
                        </select>
                    </div>
                </div>
                <div class="form-inline" style="vertical-align: middle;">
                    <label>i_先頭アドレス<span style="color: #ff0000;">*</span></label>
                    <select id="string-deviceType[0]" style="width: 50px;">
                        <option selected="selected" value="IR">IR</option>
                        <option value="HR">HR</option>
                    </select>
                    <input type="text" style="width: 80px; margin-right: 10px;"
                        id="string-src[0]">
                    <label>i_ワード数<span style="color: #ff0000;">*</span></label>
                    <input type="number" min="1" style="width: 50px; margin-right: 10px;"
                        id="string-num[0]">
                </div>
            </div>
            <div class="form-row hidden" id="block-numList[0]" name="numList"
                    style="margin-left: 10px;">
                <div class="form-row">
                    <div class="form-inline" style="vertical-align: middle;" >
                        <label>i_データ名称<span style="color: #ff0000;">*</span></label>
                        <input type="text" style="width: 150px" id="numList-dName[0]">
                        <select id="numList-type[0]"
                            style="width: 100px; margin-right: 10px;">
                            <option selected="selected"　value="Word">ワード</option>
                            <option value="dWord">倍ワード</option>
                            <option value="BCD">BCD</option><
                            option value="dBCD">倍BCD</option>
                        </select>
                    </div>
                </div>
                <div class="form-inline" style="vertical-align: middle;">
                    <label>i_先頭アドレス<span style="color: #ff0000;">*</span></label>
                    <select id="numList-deviceType[0]" style="width: 50px;">
                        <option selected="selected" value="IR">IR</option>
                        <option value="HR">HR</option>
                    </select>
                    <input type="text" style="width: 80px; margin-right: 10px;"
                        id="numList-src[0]">
                    <label>i_ワード数<span style="color: #ff0000;">*</span></label>
                    <input type="number" min="1"style="width: 50px; margin-right: 10px;"
                        id="numList-num[0]">
                </div>
                <br>
            </div>
        </div>
    </div>
    <!-- Addボタン -->
    <div class="form-block">
      <input type="button" id="form_add" name="add_btn" value="i_追加">
    </div>


</script>

<script type="text/x-red" data-help-name="Modbus-dItems">
    <p>preparing ia-cloud objects for store to CCS</p>

<h3>Inputs</h3>
<dl class="message-properties">
  TBD
</dl>

<h3>Outputs</h3>
  <dl class="message-properties">
  TBD
  </dl>

<h3>Details</h3>
  <dl class="message-properties">
  TBD
  </dl>
</script>

<script type="text/javascript">

  RED.nodes.registerType('Modbus-dItems',{
      category: 'config',
      defaults: {
          name: {value:"modbusdItems"},
          contentType: {value:"PLCData", required: true},
          configObject:{value:"", required: true},
          configReady:{value:"", required: true}
      },
      label: function() {
          return this.name||this._("Modbus-dItems");
      },

      oneditprepare: function() {
        var frm_cnt = 0;
       //あれば設定データを取り出して、formに展開する。
        var conf = $("#node-config-input-configObject").val();
        if (conf) {
          var dItems = {};
          try { dItems = JSON.parse(conf); }
          catch(e) { conf = "";}
        }

        if(conf != ""){
          //設定データがあった
          //フォームを一つ保存
          var original = $('#form_block\\[0\\]');

          //一旦フォームオブジェクトをすべて削除
          $(".form-block[id^='form_block']")
              .each(function(index, formObj) {$(formObj).remove();});

          dItems.forEach(function(value, idx){
            original
            .clone()
            .hide()
            .appendTo("#blocks")
            .attr('id', 'form_block[' + idx + ']') // クローンのid属性を変更。
            .end() // 一度適用する
            .find('div, input, select, label').each(function(index, obj) {
              if ($(obj).attr('id') != null) {
                if($(obj).attr("id").substr(0,5) == "dItem"){
                    $(obj).val("" + (idx + 1));
                }
                $(obj).attr({
                  id: $(obj).attr('id').replace(/\[[0-9]+\]$/, '[' + idx + ']')
                });
              }
              if ($(obj).attr('name') != null) {
                $(obj).attr({
                    name: $(obj).attr('name').replace(/\[[0-9]+\]$/, '[' + idx + ']')
                 });
              }
              if ($(obj).attr('for') != null) {
                $(obj).attr({
                    for: $(obj).attr('for').replace(/\[[0-9]+\]$/, '[' + idx + ']')
                });
              }
          });

          var itemType = value.options.itemType;

          switch(itemType) {
            case "bit":
                $("#bit-dName\\[" + idx + "\\]").val(value.dataName);
                $("#bit-src\\[" + idx + "\\]").val(value.options.source);
                $("#bit-deviceType\\[" + idx + "\\]").val(value.options.deviceType);
                $("#bit-num\\[" + idx + "\\]").val(value.options.number);
                $("#bit-logic\\[" + idx + "\\]").val(value.options.logic);
                break;
            case "number":
                $("#number-dName\\[" + idx + "\\]").val(value.dataName);
                $("#number-unit\\[" + idx + "\\]").val(value.unit);
                $("#number-src\\[" + idx + "\\]").val(value.options.source);
                $("#number-deviceType\\[" + idx + "\\]").val(value.options.deviceType);
                $("#number-type\\[" + idx + "\\]").val(value.options.type);
                $("#number-offset\\[" + idx + "\\]").val(value.options.offset);
                $("#number-gain\\[" + idx + "\\]").val(value.options.gain);
                break;
            case "string":
                $("#string-dName\\[" + idx + "\\]").val(value.dataName);
                $("#string-src\\[" + idx + "\\]").val(value.options.source);
                $("#string-deviceType\\[" + idx + "\\]").val(value.options.deviceType);
                $("#string-num\\[" + idx + "\\]").val(value.options.number);
                $("#string-encode\\[" + idx + "\\]").val(value.options.encode);
                break;
            case "numList":
                $("#numList-dName\\[" + idx + "\\]").val(value.dataName);
                $("#numList-src\\[" + idx + "\\]").val(value.options.source);
                $("#numList-deviceType\\[" + idx + "\\]").val(value.options.deviceType);
                $("#numList-num\\[" + idx + "\\]").val(value.options.number);
                $("#numList-type\\[" + idx + "\\]").val(value.options.type);
                break;
          }
          var block = $('#form_block\\[' + idx + '\\]');
          if (idx != 0) block.find('input[name="del_btn"]').show();
//          $("select[name='dataType\\[" + idx + "\\]']").val(itemType);
          block.children('div[id ^= "block-"]').each(function(ind,obj){
              if ($(obj).attr("name") == itemType) $(obj).show();
              else $(obj).hide();
          });
          $(function(){
              $("select[name='dataType\\[" + idx + "\\]']").val(itemType);
          });

          block.slideDown('slow');
          frm_cnt = idx;
        });
        }

        //追加ボタンが押されたら
        $("#form_add").off("click");
        $("#form_add").on("click", function() {

          var original = $('#form_block\\[' + frm_cnt + '\\]');
          var itemType =
              original.find("select[id='dataType\\[" + frm_cnt + "\\]']").val();
          frm_cnt++;
          original
          .clone()
          .hide()
          .insertAfter(original)
          .attr('id', 'form_block[' + frm_cnt + ']'); // クローンのid属性を変更。
          var clone = $('#form_block\\[' + frm_cnt + '\\]');
          clone.find('div, input, select, label').each(function(idx, obj) {
            if ($(obj).attr('id') != null) {
              if($(obj).attr("id").substr(0,5) == "dItem"){
                  $(obj).val("" + (frm_cnt + 1));
              }
              $(obj).attr({
                id: $(obj).attr('id').replace(/\[[0-9]+\]$/, '[' + frm_cnt + ']')
              });
            }
            if ($(obj).attr('name') != null) {
              $(obj).attr({
                name: $(obj).attr('name').replace(/\[[0-9]+\]$/, '[' + frm_cnt + ']')
               });
            }
            if ($(obj).attr('for') != null) {
              $(obj).attr({
                for: $(obj).attr('for').replace(/\[[0-9]+\]$/, '[' + frm_cnt + ']')
              });
            }
          });
          clone.find('input[name="del_btn"]').show();
          clone.children("div[id = 'block-\\[" + frm_cnt + "\\]']").each(function(ind,obj){
              if ($(obj).attr("name") == itemType) $(obj).show();
              else $(obj).hide();
          });
          clone.find("select[id='dataType\\[" + frm_cnt + "\\]']").val(itemType);
          clone.slideDown('fast');
        });

        //削除ボタンが押されたら
        $("#blocks").off('click', 'input[name="del_btn"]');
        $("#blocks").on('click', 'input[name="del_btn"]', function() {
          var removeObj = $(this).parents(".form-block");
          removeObj.fadeOut('fast', function() {
            removeObj.remove();
            // 番号振り直し
            frm_cnt = 0;
            $(".form-block[id^='form_block']").each(function(index, formObj) {
              if ($(formObj).attr('id') != 'form_block[0]') {
                frm_cnt++;
                $(formObj)
                  .attr('id', 'form_block[' + frm_cnt + ']') // id属性を変更。
                  .find('div, input, select, label').each(function(idx, obj) {
                   if ($(obj).attr('id') != null) {
                      if($(obj).attr("id").substr(0,5) == "dItem"){
                            $(obj).val("" + (frm_cnt + 1));
                      }
                      $(obj).attr({
                        id: $(obj).attr('id').replace(/\[[0-9]+\]$/,'['+frm_cnt+']')
                      });
                    }
                    if ($(obj).attr('name') != null) {
                      $(obj).attr({
                        name: $(obj).attr('name').replace(/\[[0-9]+\]$/,'['+frm_cnt+']')
                      });
                    }
                    if ($(obj).attr('for') != null) {
                      $(obj).attr({
                        for: $(obj).attr('for').replace(/\[[0-9]+\]$/,'['+frm_cnt+']')
                      });
                    }
                  });
              }
            });
          });
        });
        //データタイプボタンが変化したら
        $("#blocks").off('change', 'select[name^="dataType"]');
        $("#blocks").on('change', 'select[name^="dataType"]', function() {
            var val = $(this).val();
            $(this)
            .parents(".form-block").children('div[id ^= "block-"]')
            .each(function(idx,obj){
                if ($(obj).attr("name") == val) $(obj).show();
                else $(obj).hide();
            });
        });
    },

      oneditsave: function() {

        var dItems = [];
        var configReady = "ready";

        $(".form-block[id^='form_block']").each(function(idx, obj){
          var itemType = $(obj)
              .find("select[name='dataType\\[" + idx + "\\]']").val();
          var item ={options:{}};
          item.options.itemType = itemType;
          switch(itemType) {
            case "bit":
              item.dataName = $("#bit-dName\\[" + idx + "\\]").val();
              if (!item.dataName) configReady = "";
              item.options.source = $("#bit-src\\[" + idx + "\\]").val();
              if (!item.options.source) configReady = "";
              item.options.deviceType = $("#bit-deviceType\\[" + idx + "\\]").val();
              if (!item.options.deviceType) configReady = "";
              item.options.number = $("#bit-num\\[" + idx + "\\]").val();
              if (!item.options.number) configReady = "";
              item.options.logic = $("#bit-logic\\[" + idx + "\\]").val();
              break;
            case "number":
              item.dataName = $("#number-dName\\[" + idx + "\\]").val();
              if (!item.dataName) configReady = "";
              item.unit = $("#number-unit\\[" + idx + "\\]").val();
              item.options.source = $("#number-src\\[" + idx + "\\]").val();
              if (!item.options.source) configReady = "";
              item.options.deviceType = $("#number-deviceType\\[" + idx + "\\]").val();
              if (!item.options.deviceType) configReady = "";
              item.options.type = $("#number-type\\[" + idx + "\\]").val();
              item.options.offset = $("#number-offset\\[" + idx + "\\]").val();
              item.options.gain = $("#number-gain\\[" + idx + "\\]").val();
              break;
            case "string":
              item.dataName = $("#string-dName\\[" + idx + "\\]").val();
              if (!item.dataName) configReady = "";
              item.options.source = $("#string-src\\[" + idx + "\\]").val();
              if (!item.options.source) configReady = "";
              item.options.deviceType = $("#string-deviceType\\[" + idx + "\\]").val();
              if (!item.options.deviceType) configReady = "";
              item.options.number = $("#string-num\\[" + idx + "\\]").val();
              if (!item.options.number) configReady = "";
              item.options.encode = $("#string-encode\\[" + idx + "\\]").val();
              break;
            case "numList":
              item.dataName = $("#numList-dName\\[" + idx + "\\]").val();
              if (!item.dataName) configReady = "";
              item.options.source = $("#numList-src\\[" + idx + "\\]").val();
              if (!item.options.source) configReady = "";
              item.options.deviceType = $("#numList-deviceType\\[" + idx + "\\]").val();
              if (!item.options.deviceType) configReady = "";
              item.options.number = $("#numList-num\\[" + idx + "\\]").val();
              if (!item.options.number) configReady = "";
              item.options.type = $("#numList-type\\[" + idx + "\\]").val();
              break;
          }
        dItems[idx]=item;
      });

      $("#node-config-input-configReady").val(configReady);
      //フォームの各要素をobjectに記述し、JSON文字列に変換する。
      try {$("#node-config-input-configObject").val(JSON.stringify(dItems));}
      catch(e) {$("#node-config-input-configObject").val("")}
    }
  });

</script>
