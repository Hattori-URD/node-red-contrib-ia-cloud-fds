<!--
  Copyright JS Foundation and other contributors, http://js.foundation
  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at
  http://www.apache.org/licenses/LICENSE-2.0
  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/x-red" data-template-name="Modbus-AandE">

    <div class="form-row">
        <label for="node-config-input-name">
            <i class="fa fa-tag"></i>i_Node name</label>
        <input type="text" id="node-config-input-name">
    </div>
    <div class="form-row">
      <label for="node-config-input-contentType"><i class="fa fa-tag"></i>
          i_データ種別</label>
      <input type="text" id="node-config-input-contentType" disabled="disabled">
    </div>
    <div class="form-row hidden">
        <input type="text" id="node-config-input-configObject">
        <input type="text" id="node-config-input-configReady">
    </div>
  <div id="blocks">
      <div class="form-block" id="form_block[0]">

          <div class="form-row">
            <div class="form-inline" id="from_del[0]" >
              <span style="border-bottom:solid 2px;">i_データ項目 :</span>
              <input type="text" id="dItem[0]" style="width: 30px;" value="1"
                  disabled="disabled">
              <input type="button" name="del_btn" value="i_削除"
                  style="margin-left: 30px; width: 70px; display: none;">
              </div>
          </div>
          <div class="form-row">
              <div class="form-inline" style="vertical-align: middle;">
                  <label>i_先頭アドレス<span style="color: #ff0000;">*</span></label>
                  <select id="deviceType[0]" style="width: 50px;">
                      <option selected="selected"　value="Coil">Coil</option>
                      <option value="IS">IS</option>
                      <option value="IR">IR</option>
                      <option value="HR">HR</option>
                  </select>
                  <input type="text" style="margin-right: 10px; width: 80px" id="source[0]">
                  <select style="width: 70px" id="logic[0]">
                      <option selected="selected"　value= "pos">正論理</option>
                      <option value= "neg">負論理</option>
                  </select>
              </div>
          </div>
          <div class="form-row">
              <label>i_A&Eコード</label>
              <input type="text" style="width: 100px;" id="AandECode[0]">
          </div>
          <div class="form-row">
              <label>i_A&Eの説明</label>
              <textarea style="width: 300px" id="AandEdescription[0]" rows="2"></textarea>
          </div>
          <br>
      </div>
  </div>
    <!-- Addボタン -->
    <div class="form-block">
      <input type="button" id="form_add" name="add_btn" value="i_追加">
    </div>

</script>

<script type="text/x-red" data-help-name="Modbus-AandE">
    <p>preparing ia-cloud objects for store to CCS</p>

<h3>Inputs</h3>
<dl class="message-properties">
  TBD
</dl>

<h3>Outputs</h3>
  <dl class="message-properties">
  TBD
  </dl>

<h3>Details</h3>
  <dl class="message-properties">
  TBD
  </dl>
</script>

<script type="text/javascript">

  RED.nodes.registerType('Modbus-AandE',{
      category: 'config',
      defaults: {
          name: {value:"modbusA&E"},
          contentType: {value:"Alarm&Event", required: true},
          configObject:{value:"", required: true },
          configReady:{value:"", required: true }
      },
      label: function() {
          return this.name||this._("Modbus-A&E");
      },
      oneditprepare: function() {
        var frm_cnt = 0;
        //あれば設定データを取り出して、formに展開する。
        var conf = $("#node-config-input-configObject").val();
        if (conf) {
          var dItems = {};
          try { dItems = JSON.parse(conf); }
          catch(e) { conf = "";}
        }
        if(conf != ""){
          //設定データがあった
          var dItems = JSON.parse(conf);
          //フォームを一つ保存
          var original = $('#form_block\\[0\\]');

          //一旦フォームオブジェクトをすべて削除
          $(".form-block[id^='form_block']")
              .each(function(index, formObj) {$(formObj).remove();});

          dItems.forEach(function(value, idx){
            original
            .clone()
            .hide()
            .appendTo("#blocks")
            .attr('id', 'form_block[' + idx + ']') // クローンのid属性を変更。
            .end() // 一度適用する
            .find('div, input, textarea, select, label').each(function(index, obj) {
              if ($(obj).attr('id') != null) {
                if($(obj).attr("id").substr(0,5) == "dItem"){
                    $(obj).val("" + (idx + 1));
                }
                $(obj).attr({
                  id: $(obj).attr('id').replace(/\[[0-9]+\]$/, '[' + idx + ']')
                });
              }
              if ($(obj).attr('name') != null) {
                $(obj).attr({
                    name: $(obj).attr('name').replace(/\[[0-9]+\]$/, '[' + idx + ']')
                 });
              }
              if ($(obj).attr('for') != null) {
                $(obj).attr({
                    for: $(obj).attr('for').replace(/\[[0-9]+\]$/, '[' + idx + ']')
                });
              }
          });
          $("#deviceType\\[" + idx + "\\]").val(value.options.deviceType);
          $("#source\\[" + idx + "\\]").val(value.options.source);
          $("#logic\\[" + idx + "\\]").val(value.options.logic);
          $("#AandECode\\[" + idx + "\\]").val(value.dataValue.AandECode);
          $("#AandEdescription\\[" + idx + "\\]").val(value.dataValue.AandEdescription);

          var block = $('#form_block\\[' + idx + '\\]');
          if (idx != 0) block.find('input[name="del_btn"]').show();
          block.slideDown('slow');
          frm_cnt = idx;
          });
        }

        //追加ボタンが押されたら
        $("#form_add").off("click");
        $("#form_add").on("click", function() {

          var original = $('#form_block\\[' + frm_cnt + '\\]');
          frm_cnt++;
          original
          .clone()
          .hide()
          .insertAfter(original)
          .attr('id', 'form_block[' + frm_cnt + ']'); // クローンのid属性を変更。
          var clone = $('#form_block\\[' + frm_cnt + '\\]');
          clone.find('div, input, textarea, select, label').each(function(idx, obj) {
            if ($(obj).attr('id') != null) {
              if($(obj).attr("id").substr(0,5) == "dItem"){
                  $(obj).val("" + (frm_cnt + 1));
              }
              $(obj).attr({
                id: $(obj).attr('id').replace(/\[[0-9]+\]$/, '[' + frm_cnt + ']')
              });
            }
            if ($(obj).attr('name') != null) {
              $(obj).attr({
                name: $(obj).attr('name').replace(/\[[0-9]+\]$/, '[' + frm_cnt + ']')
               });
            }
            if ($(obj).attr('for') != null) {
              $(obj).attr({
                for: $(obj).attr('for').replace(/\[[0-9]+\]$/, '[' + frm_cnt + ']')
              });
            }
          });
          clone.find('input[name="del_btn"]').show();
          clone.slideDown('fast');
        });

        //削除ボタンが押されたら
        $("#blocks").off('click', 'input[name="del_btn"]');
        $("#blocks").on('click', 'input[name="del_btn"]', function() {
          var removeObj = $(this).parents(".form-block");
          removeObj.fadeOut('fast', function() {
            removeObj.remove();
            // 番号振り直し
            frm_cnt = 0;
            $(".form-block[id^='form_block']").each(function(index, formObj) {
              if ($(formObj).attr('id') != 'form_block[0]') {
                frm_cnt++;
                $(formObj)
                  .attr('id', 'form_block[' + frm_cnt + ']') // id属性を変更。
                  .find('div, input, textarea, select, label').each(function(idx, obj) {
                   if ($(obj).attr('id') != null) {
                      if($(obj).attr("id").substr(0,5) == "dItem"){
                            $(obj).val("" + (frm_cnt + 1));
                      }
                      $(obj).attr({
                        id: $(obj).attr('id').replace(/\[[0-9]+\]$/,'['+frm_cnt+']')
                      });
                    }
                    if ($(obj).attr('name') != null) {
                      $(obj).attr({
                        name: $(obj).attr('name').replace(/\[[0-9]+\]$/,'['+frm_cnt+']')
                      });
                    }
                    if ($(obj).attr('for') != null) {
                      $(obj).attr({
                        for: $(obj).attr('for').replace(/\[[0-9]+\]$/,'['+frm_cnt+']')
                      });
                    }
                  });
              }
            });
          });
        });
      },

      oneditsave: function() {

        var dItems = [];
        var configReady = "ready";
          $(".form-block[id^='form_block']").each(function(idx, obj){
              var item ={commonName: "Alarm&Event", dataValue: {}, options:{}};

              item.options.deviceType = $("#deviceType\\[" + idx + "\\]").val();
              item.options.source = $("#source\\[" + idx + "\\]").val();
              if (!item.options.source) configReady = "";
              item.options.logic = $("#logic\\[" + idx + "\\]").val();
              item.dataValue.AandECode = $("#AandECode\\[" + idx + "\\]").val();
              item.dataValue.AandEdescription = $("#AandEdescription\\[" + idx + "\\]").val();

              dItems[idx]=item;
          });
          $("#node-config-input-configReady").val(configReady);
          //フォームの各要素をobjectに記述し、JSON文字列に変換する。
          try {$("#node-config-input-configObject").val(JSON.stringify(dItems));}
          catch(e) {$("#node-config-input-configObject").val("")}

      }
    });

</script>
