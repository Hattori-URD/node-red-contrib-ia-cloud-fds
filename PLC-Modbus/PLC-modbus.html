<!--
  Copyright JS Foundation and other contributors, http://js.foundation
  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at
  http://www.apache.org/licenses/LICENSE-2.0
  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/x-red" data-template-name="PLC-Modbus">

    <div class="form-row">
        <label for="node-input-name" ><i class="fa fa-tag"></i><span data-i18n="editor.name"></span></label>
        <input type="text" class="form-control" id="node-input-name">
    </div>
    <!-- modbus node（設定Node）の選択-->
    <div class="form-row">
        <label for="node-input-ModbusCom" style= "vertical-align: middle;">
            <span data-i18n="editor.modbusNode"></span><span style="color: #ff0000;">*</span></label>
        <input type="text" style="width: 300px" id="node-input-ModbusCom">
    </div>
<hr>

    <!-- 隠しのNodeプロパティ -->
    <div class="form-row hide">
        <input type="text" id="node-input-configReady">
    </div>
    <div class="form-row hide">
        <input type="text" id="node-input-configJson">
    </div>
    <!-- ui-config か fileSet かのラジオ -->
    <div class="form-row">
      <input type="text" style="display: none;" id="node-input-confsel" value="ui-config">
      <input type="radio" style="display: inline-block; width: auto; vertical-align: top;"
            name="configSel" id="configSel1"
            value="ui-config" checked="checked">
      <label style="width: 40%;" for="configSel1"><span data-i18n="editor.ui-config"></label>
      <input type="radio" style="display: inline-block; width: auto; vertical-align: top;"
            name="configSel" id="configSel2" value="fileSet">
      <label style="width: 40%;" for="configSel2"><span data-i18n="editor.fileConfig"></label>
    </div>

    <!-- ファイルからの設定情報リード -->
    <div id="file-conf" class="hide">
      <div class="form-row" style="margin-left: 20px;">
          <label style="width: 80%;"><span data-i18n="editor.filename"></span><span style="color: #ff0000;">*</span></label>
          <input id="configfile" type="file" accept=".json">
      </div>
      <div class="form-row" style="margin-left: 20px;">
          <textarea id="fileConfig" name="fileConfig" rows="12" style="width: 400px"  disabled></textarea>
      </div>
    </div>





    <div id="ui-config">
      <!-- Tab, ownself -->
      <div class="red-ui-tabs" id="ui-tabs">
        <ul>
          <li class="red-ui-tab active" style="width: 50%;"><a href="#tab1"
            class="nav-link red-ui-tab-label" data-toggle="tab">
            <span data-i18n="editor.tab.object-settings" /></a>
          </li>
          <li class="red-ui-tab" style="width: 50%;"><a href="#tab2"
            class="nav-link red-ui-tab-label" data-toggle="tab">
            <span data-i18n="editor.tab.data-settings" /></a>
          </li>
        </ul>
      </div>

      <!-- Tab contents -->
      <div class="tab-content">

        <!-- tab1 starts -->
        <div id="tab1" class="tab-pane active">
          <!-- object propertyの設定 -->
          <div class="form-group" style="margin-left: 20px;">
              <div class="form-row">
                  <label style="margin-right: 10px;" for="storeInterval">
                      <span data-i18n="editor.period"></span></label>
                  <input type="number" id="storeInterval" min="0" step="10"
                      value="300" style="display: inline-block; width: auto;">
                  <label for="storeAsync" style="margin-left: 20px;">
                      <span data-i18n="editor.async"></span></label>
                  <input type="checkbox" checked="checked" id="storeAsync"
                      style="display: inline-block; width: auto;" >
              </div>
              <div class="form-row">
                  <label style="margin-right: 10px;" for="objectName">
                      <span data-i18n="editor.objectname"></span></label>
                  <input type="text" style="width: 300px" id="objectName">
              </div>
              <div class="form-row">
                  <label style="margin-right: 10px;"
                      for="objectKey"><span data-i18n="editor.objectKey"></span>
                      <span style="color: #ff0000;">*</span></label>
                  <input class="form-control" type="text" style="width: 300px"
                   id="objectKey" data-i18n="[placeholder]editor.objectKeyholder">
              </div>
              <div class="form-row">
                  <label style="margin-right: 10px;"
                      for="objectdescription"><span data-i18n="editor.objectDescription"></span></label>
                  <input type="text" style="width: 300px" id="objectDescription">
              </div>
          </div>
        </div>
        <!-- tab1 ends -->

        <!-- tab2 starts -->
        <div id="tab2" class="tab-pane">
          <!-- dataItem propertyの設定 -->
          <div class="form-row">
            <label for="contentType"><i class="fa fa-tag"></i>
                <span data-i18n="editor.contentType"></span></label>
            <input type="text" id="contentType" value="ModbusPLC">
          </div>
          <div id="blocks">
              <div class="form-block" id="form_block[0]">
                  <div class="form-row">
                    <div class="form-inline" id="from_del[0]" >
                      <span style="border-bottom:solid 2px;"><span data-i18n="editor.itemNumber"></span></span>
                      <input type="text" id="dItem[0]" style="width: 30px;" value="1"
                          disabled="disabled">
                      <select style="width: 150px; margin-left: 30px;" name="dataType[0]"
                          id="dataType[0]">
                          <option selected="selected" value="bit" data-i18n="editor.bit"></option>
                          <option value="number" data-i18n="editor.number"></option>
                          <option value="string" data-i18n="editor.string"></option>
                          <option value="numList" data-i18n="editor.numList"></option>
                      </select>
                      <input type="button" name="del_btn" data-i18n="[value]editor.del"
                          style="margin-left: 30px; width: 70px; display: none;">
                      </div>
                  </div>
                  <div class="form-row" id="block-bit[0]" name="bit" style="margin-left: 10px;">
                      <div class="form-row">
                          <div class="form-inline" style="vertical-align: middle;" >
                              <label><span data-i18n="editor.dname"></span><span style="color: #ff0000;">*</span></label>
                              <input type="text" style="width: 150px;" id="bit-dName[0]">
                          </div>
                      </div>
                      <div class="form-row">
                          <div class="form-inline" style="vertical-align: middle;">
                              <label><span data-i18n="editor.address"></span><span style="color: #ff0000;">*</span></label>
                              <select id="bit-deviceType[0]" style="width: 50px;">
                                  <option selected="selected" value="Coil">Coil</option>
                                  <option value="IS">IS</option>
                              </select>
                              <input type="text" style="margin-right: 10px; width: 150px"
                                  id="bit-src[0]">
                          </div>
                      </div>
                      <div class="form-row">
                          <div class="form-inline" style="vertical-align: middle;">
                              <label><span data-i18n="editor.bitNum"></span><span style="color: #ff0000;">*</span></label>
                              <input type="number" min="1" style="margin-right: 10px; width: 50px"
                                  id="bit-num[0]" value="1">
                              <select style="width: 70px" id="bit-logic[0]">
                                  <option selected="selected" value= "pos" data-i18n="editor.pos"></option>
                                  <option value= "neg" data-i18n="editor.neg"></option>
                              </select>
                          </div>
                      </div>
                  </div>
                  <div class="form-row hidden" id="block-number[0]" name="number"
                          style="margin-left: 10px;">
                      <div class="form-row">
                          <div class="form-inline" style="vertical-align: middle;" >
                              <label><span data-i18n="editor.dname"></span><span style="color: #ff0000;">*</span></label>
                              <input type="text" style="width: 150px; margin-right: 20px;"
                                  id="number-dName[0]">
                              <label style="width: 50px"><span data-i18n="editor.unit"></span></label>
                              <input type="text" style="width: 50px; margin-right: 10px;"
                                  id="number-unit[0]">
                          </div>
                      </div>
                      <div class="form-row">
                          <div class="form-row">
                              <div class="form-inline" style="vertical-align: middle;">
                                  <label><span data-i18n="editor.address"></span><span style="color: #ff0000;">*</span></label>
                                  <select id="number-deviceType[0]" style="width: 50px;">
                                      <option selected="selected" value="IR">IR</option>
                                      <option value="HR">HR</option>
                                  </select>
                                  <input type="text" style="width: 120px; margin-right: 10px;"
                                      id="number-src[0]">
                                  <select id="number-type[0]" style="width: 100px;">
                                      <option selected="selected" value="1w">1word</option>
                                      <option value="2w-b">2word-big</option>
                                      <option value="2w-l">2word-little</option>
                                  </select>
                              </div>
                          </div>
                          <div class="form-row">
                              <div class="form-inline" style="vertical-align: middle;">
                                  <label><span data-i18n="editor.dType"></span></label>
                                  <select id="number-encode[0]" style="width: 100px;">
                                      <option selected="selected" value="unsigned" data-i18n="editor.unsigned"></option>
                                      <option value="signed" data-i18n="editor.signed"></option>
                                      <option value="BCD" data-i18n="editor.BCD"></option>
                                  </select>
                                  <label style="width:50px; margin-left: 10px;"><span data-i18n="editor.offset"></span></label>
                                  <input type="number" style="width: 50px; margin-right: 10px;"
                                      id="number-offset[0]" value="0">
                                  <label style="width:50px;"><span data-i18n="editor.gain"></span></label>
                                  <input type="number" style="width: 50px;"
                                      id="number-gain[0]" value="1">
                              </div>
                          </div>
                      </div>
                  </div>
                  <div class="form-row hidden" id="block-string[0]" name="string"
                          style="margin-left: 10px;">
                      <div class="form-row">
                          <div class="form-inline" style="vertical-align: middle;" >
                              <label><span data-i18n="editor.dname"></span><span style="color: #ff0000;">*</span></label>
                              <input type="text" style="width: 150px" id="string-dName[0]">
                              <select id="string-encode[0]"
                                  style="width: 100px; margin-right: 10px;">
                                  <option value="sJIS" data-i18n="editor.sjis"></option>
                                  <option selected="selected" value="utf-8" data-i18n="editor.utf"></option>
                                  <option value="EUC" data-i18n="editor.euc"></option>
                              </select>
                          </div>
                      </div>
                      <div class="form-inline" style="vertical-align: middle;">
                          <label><span data-i18n="editor.address"></span><span style="color: #ff0000;">*</span></label>
                          <select id="string-deviceType[0]" style="width: 50px;">
                              <option selected="selected" value="IR">IR</option>
                              <option value="HR">HR</option>
                          </select>
                          <input type="text" style="width: 80px; margin-right: 10px;"
                              id="string-src[0]">
                          <label><span data-i18n="editor.wnumber"></span><span style="color: #ff0000;">*</span></label>
                          <input type="number" min="1" style="width: 50px; margin-right: 10px;"
                              id="string-num[0]">
                      </div>
                  </div>
                  <div class="form-row hidden" id="block-numList[0]" name="numList"
                          style="margin-left: 10px;">
                      <div class="form-row">
                          <div class="form-inline" style="vertical-align: middle;" >
                              <label><span data-i18n="editor.dname"></span><span style="color: #ff0000;">*</span></label>
                              <input type="text" style="width: 150px" id="numList-dName[0]">
                          </div>
                      </div>
                      <div class="form-row">
                          <div class="form-inline" style="vertical-align: middle;">
                              <label><span data-i18n="editor.address"></span><span style="color: #ff0000;">*</span></label>
                              <select id="numList-deviceType[0]" style="width: 50px;">
                                  <option selected="selected" value="IR">IR</option>
                                  <option value="HR">HR</option>
                              </select>
                              <input type="text" style="width: 120px; margin-right: 10px;"
                                  id="numList-src[0]">
                              <select id="numList-type[0]" style="width: 100px;">
                                  <option selected="selected" value="1w">1word</option>
                                  <option value="2w-b">2word-big</option>
                                  <option value="2w-l">2word-little</option>
                              </select>
                          </div>
                      </div>
                      <div class="form-row">
                          <div class="form-inline" style="vertical-align: middle;">
                              <label><span data-i18n="editor.wnumber"></span><span style="color: #ff0000;">*</span></label>
                              <input type="number" min="1"style="width: 50px; margin-right: 10px;"
                                  id="numList-num[0]">
                              <select id="numList-encode[0]"
                                  style="width: 100px; margin-right: 10px;">
                                  <option selected="selected" value="unsigned" data-i18n="editor.unsigned"></option>
                                  <option value="signed" data-i18n="editor.signed"></option>
                                  <option value="BCD" data-i18n="editor.BCD"></option>
                              </select>
                          </div>
                      </div>
                  </div>
              </div>
          </div>
          <!-- Addボタン -->
          <div class="form-block">
            <input type="button" id="form_add" name="add_btn"  data-i18n="[value]editor.add">
          </div>

        </div>
        <!-- tab2 ends -->
      </div>
    </div>

</script>

<script type="text/x-red" data-help-name="PLC-Modbus">
    <p>preparing ia-cloud objects for store to CCS</p>

<h3>Inputs</h3>
<dl class="message-properties">
  TBD
</dl>

<h3>Outputs</h3>
  <dl class="message-properties">
  TBD
  </dl>

<h3>Details</h3>
  <dl class="message-properties">
  TBD
  </dl>
</script>

<script type="text/javascript">

  RED.nodes.registerType('PLC-Modbus',{
    category: 'iaCloud',
    color:"rgb(231, 180, 100)",
    defaults: {
        name: {value:"PLC-Modbus"},
        confsel: {value:"ui-config", required: true},
        configJson: {value:"", required: true},
        ModbusCom: {value:"", type:"Modbus-com", required: true},
        configReady: {value: "", required: true}
    },
    inputs:1,
    outputs:1,
    icon: "ia-cloud.png",  //アイコンはTBD
    label: function() {
        return this.name||this._("Plc-object");
    },
    labelStyle: function() {
        return this.name?"node_label_italic":"";
    },
    oneditprepare: function() {

        // データItemの数を保持する変数
        var frm_cnt = 0;

        // 設定方法を確認（"ui-config" or "fileSet"）
        $('input[name="configSel"]:radio').change(function() {
              if ($("#configSel1").is(":checked")) {
                  $("#file-conf").hide();
                  $("#ui-config").show();
                  $('#node-input-confsel').val("ui-config");
              } else {
                  $("#file-conf").show();
                  $("#ui-config").hide();
                  $('#node-input-confsel').val("fileSet");
              }
        });
        if($("#node-input-confsel").val() == "ui-config"){
          $('#configSel1').prop('checked', true);
        } else {
          $('#configSel2').prop('checked', true);
        }
        $('input[name="configSel"]:radio').change();

        // ファイルでの設定の場合
        if ($("#node-input-confsel").val() == "fileSet") {
          $("#fileConfig").val($("#node-input-configJson").val());
        }

        // UIでの設定の場合
        if ($("#node-input-confsel").val() == "ui-config") {
          // 設定データを取り出して、各formに展開する。
          if ($("#node-input-configJson").val()) {

            try{ var conf = JSON.parse($("#node-input-configJson").val());}
            catch(e){ conf = null; }
          }
          //設定データがあったら
          if(conf) {
            $("#storeInterval").val(conf[0].options.storeInterval);
            $("#storeAsync").prop("checked", conf[0].options.storeAsync);
            $("#objectName").val(conf[0].objectName);
            $("#objectKey").val(conf[0].objectKey);
            $("#objectDescription").val(conf[0].objectDescription);

            $("contentType").val(conf[0].ObjectContent.contentType);
            var dItems = conf[0].ObjectContent.contentData;

            //フォームを一つ保存
            var original = $('#form_block\\[0\\]');

            //一旦フォームオブジェクトをすべて削除
            $(".form-block[id^='form_block']")
                .each(function(index, formObj) {$(formObj).remove();});

            dItems.forEach(function(value, idx){
              original
              .clone()
              .hide()
              .appendTo("#blocks")
              .attr('id', 'form_block[' + idx + ']') // クローンのid属性を変更。
              .end() // 一度適用する
              .find('div, input, select, label').each(function(index, obj) {
                if ($(obj).attr('id') != null) {
                  if($(obj).attr("id").substr(0,5) == "dItem"){
                      $(obj).val("" + (idx + 1));
                  }
                  $(obj).attr({
                    id: $(obj).attr('id').replace(/\[[0-9]+\]$/, '[' + idx + ']')
                  });
                }
                if ($(obj).attr('name') != null) {
                  $(obj).attr({
                      name: $(obj).attr('name').replace(/\[[0-9]+\]$/, '[' + idx + ']')
                   });
                }
                if ($(obj).attr('for') != null) {
                  $(obj).attr({
                      for: $(obj).attr('for').replace(/\[[0-9]+\]$/, '[' + idx + ']')
                  });
                }
              });

            var itemType = value.options.itemType;

            switch(itemType) {
              case "bit":
                  $("#bit-dName\\[" + idx + "\\]").val(value.dataName);
                  $("#bit-src\\[" + idx + "\\]").val(value.options.source);
                  $("#bit-deviceType\\[" + idx + "\\]").val(value.options.deviceType);
                  $("#bit-num\\[" + idx + "\\]").val(value.options.number);
                  $("#bit-logic\\[" + idx + "\\]").val(value.options.logic);
                  break;
              case "number":
                  $("#number-dName\\[" + idx + "\\]").val(value.dataName);
                  $("#number-unit\\[" + idx + "\\]").val(value.unit);
                  $("#number-src\\[" + idx + "\\]").val(value.options.source);
                  $("#number-deviceType\\[" + idx + "\\]").val(value.options.deviceType);
                  $("#number-type\\[" + idx + "\\]").val(value.options.type);
                  $("#number-encode\\[" + idx + "\\]").val(value.options.encode);
                  $("#number-offset\\[" + idx + "\\]").val(value.options.offset);
                  $("#number-gain\\[" + idx + "\\]").val(value.options.gain);
                  break;
              case "string":
                  $("#string-dName\\[" + idx + "\\]").val(value.dataName);
                  $("#string-src\\[" + idx + "\\]").val(value.options.source);
                  $("#string-deviceType\\[" + idx + "\\]").val(value.options.deviceType);
                  $("#string-num\\[" + idx + "\\]").val(value.options.number);
                  $("#string-encode\\[" + idx + "\\]").val(value.options.encode);
                  break;
              case "numList":
                  $("#numList-dName\\[" + idx + "\\]").val(value.dataName);
                  $("#numList-src\\[" + idx + "\\]").val(value.options.source);
                  $("#numList-deviceType\\[" + idx + "\\]").val(value.options.deviceType);
                  $("#numList-num\\[" + idx + "\\]").val(value.options.number);
                  $("#numList-type\\[" + idx + "\\]").val(value.options.type);
                  $("#numList-encode\\[" + idx + "\\]").val(value.options.encode);
                  break;
            }
            var block = $('#form_block\\[' + idx + '\\]');
            if (idx != 0) block.find('input[name="del_btn"]').show();
  //          $("select[name='dataType\\[" + idx + "\\]']").val(itemType);
            block.children('div[id ^= "block-"]').each(function(ind,obj){
                if ($(obj).attr("name") == itemType) $(obj).show();
                else $(obj).hide();
            });
            $(function(){
                $("select[name='dataType\\[" + idx + "\\]']").val(itemType);
            });

            block.slideDown('slow');
            frm_cnt = idx;
          });

          }
        }

        //追加ボタンが押されたら
        $("#form_add").off("click");
        $("#form_add").on("click", function() {
          var original = $('#form_block\\[' + frm_cnt + '\\]');
          var itemType =
              original.find("select[id='dataType\\[" + frm_cnt + "\\]']").val();
          frm_cnt++;
          original
          .clone()
          .hide()
          .insertAfter(original)
          .attr('id', 'form_block[' + frm_cnt + ']'); // クローンのid属性を変更。
          var clone = $('#form_block\\[' + frm_cnt + '\\]');
          clone.find('div, input, select, label').each(function(idx, obj) {
            if ($(obj).attr('id') != null) {
              if($(obj).attr("id").substr(0,5) == "dItem"){
                  $(obj).val("" + (frm_cnt + 1));
              }
              $(obj).attr({
                id: $(obj).attr('id').replace(/\[[0-9]+\]$/, '[' + frm_cnt + ']')
              });
            }
            if ($(obj).attr('name') != null) {
              $(obj).attr({
                name: $(obj).attr('name').replace(/\[[0-9]+\]$/, '[' + frm_cnt + ']')
               });
            }
            if ($(obj).attr('for') != null) {
              $(obj).attr({
                for: $(obj).attr('for').replace(/\[[0-9]+\]$/, '[' + frm_cnt + ']')
              });
            }
          });
          clone.find('input[name="del_btn"]').show();
          clone.children("div[id = 'block-\\[" + frm_cnt + "\\]']").each(function(ind,obj){
              if ($(obj).attr("name") == itemType) $(obj).show();
              else $(obj).hide();
          });
          clone.find("select[id='dataType\\[" + frm_cnt + "\\]']").val(itemType);
          clone.slideDown('fast');
        });

        //削除ボタンが押されたら
        $("#blocks").off('click', 'input[name="del_btn"]');
        $("#blocks").on('click', 'input[name="del_btn"]', function() {
          var removeObj = $(this).parents(".form-block");
          removeObj.fadeOut('fast', function() {
            removeObj.remove();
            // 番号振り直し
            frm_cnt = 0;
            $(".form-block[id^='form_block']").each(function(index, formObj) {
              if ($(formObj).attr('id') != 'form_block[0]') {
                frm_cnt++;
                $(formObj)
                  .attr('id', 'form_block[' + frm_cnt + ']') // id属性を変更。
                  .find('div, input, select, label').each(function(idx, obj) {
                   if ($(obj).attr('id') != null) {
                      if($(obj).attr("id").substr(0,5) == "dItem"){
                            $(obj).val("" + (frm_cnt + 1));
                      }
                      $(obj).attr({
                        id: $(obj).attr('id').replace(/\[[0-9]+\]$/,'['+frm_cnt+']')
                      });
                    }
                    if ($(obj).attr('name') != null) {
                      $(obj).attr({
                        name: $(obj).attr('name').replace(/\[[0-9]+\]$/,'['+frm_cnt+']')
                      });
                    }
                    if ($(obj).attr('for') != null) {
                      $(obj).attr({
                        for: $(obj).attr('for').replace(/\[[0-9]+\]$/,'['+frm_cnt+']')
                      });
                    }
                  });
              }
            });
          });
        });

        //データタイプボタンが変化したら
        $("#blocks").off('change', 'select[name^="dataType"]');
        $("#blocks").on('change', 'select[name^="dataType"]', function() {
            var val = $(this).val();
            $(this)
            .parents(".form-block").children('div[id ^= "block-"]')
            .each(function(idx,obj){
                if ($(obj).attr("name") == val) $(obj).show();
                else $(obj).hide();
            });
        });

        // 設定ファイルが設定されたら
        $('#configfile').on("change",function(){
          if ($('#configfile').val() !== '') {
              var fileConfig = "";
              //propを使って、file[0]にアクセスする
              var configfile = $('#configfile').prop('files')[0];
              // ファイルリーダをインスタンス化
              var reader = new FileReader();
              // 設定ファイルを読み込が完了function
              reader.onload = function () {

                  // 設定JSONを設定Objectにパース、自身の設定を探して再度JSONに
                  try{
                      var nodeConfig = JSON.parse(reader.result);
                      // 設定オブジェクトの部分のみ取り出しJSONに戻す
                      var cfgobjs = nodeConfig.find((value) =>
                          value.targetNodeName == $("#node-input-name").val()
                      );
                      if (cfgobjs) {
                          fileConfig = JSON.stringify(cfgobjs.configObjects);
                      }
                      else {
                          fileConfig = "";
                          alert("対象データがありません");
                      }
                  } catch(e) {
                    //エラーの場合
                    fileConfig = "";
                    alert("ファイルの記述が正しくありません");
                  }
                  //Textareaに設定jsonを表示
                  $("#fileConfig").val(fileConfig);
              }
              // ファイルの読み込み
              reader.readAsText(configfile);
            }
        });

    },

    oneditsave: function() {
      var configReady = "ready";
      // UI-configの場合
      if ($("#node-input-confsel").val() == "ui-config") {
        if (!$("#objectKey").val()) configReady = "";
        // データ設定を作成
        var dItems = [];
        $(".form-block[id^='form_block']").each(function(idx, obj){
          var itemType = $(obj)
              .find("select[name='dataType\\[" + idx + "\\]']").val();
          var item ={options:{}};
          item.options.itemType = itemType;
          switch(itemType) {
            case "bit":
              item.dataName = $("#bit-dName\\[" + idx + "\\]").val();
              if (!item.dataName) configReady = "";
              item.options.source = $("#bit-src\\[" + idx + "\\]").val();
              if (!item.options.source) configReady = "";
              item.options.deviceType = $("#bit-deviceType\\[" + idx + "\\]").val();
              if (!item.options.deviceType) configReady = "";
              item.options.number = $("#bit-num\\[" + idx + "\\]").val();
              if (!item.options.number) configReady = "";
              item.options.logic = $("#bit-logic\\[" + idx + "\\]").val();
              break;
            case "number":
              item.dataName = $("#number-dName\\[" + idx + "\\]").val();
              if (!item.dataName) configReady = "";
              item.unit = $("#number-unit\\[" + idx + "\\]").val();
              item.options.source = $("#number-src\\[" + idx + "\\]").val();
              if (!item.options.source) configReady = "";
              item.options.deviceType = $("#number-deviceType\\[" + idx + "\\]").val();
              if (!item.options.deviceType) configReady = "";
              item.options.type = $("#number-type\\[" + idx + "\\]").val();
              item.options.encode = $("#number-encode\\[" + idx + "\\]").val();
              item.options.offset = $("#number-offset\\[" + idx + "\\]").val();
              item.options.gain = $("#number-gain\\[" + idx + "\\]").val();
              break;
            case "string":
              item.dataName = $("#string-dName\\[" + idx + "\\]").val();
              if (!item.dataName) configReady = "";
              item.options.source = $("#string-src\\[" + idx + "\\]").val();
              if (!item.options.source) configReady = "";
              item.options.deviceType = $("#string-deviceType\\[" + idx + "\\]").val();
              if (!item.options.deviceType) configReady = "";
              item.options.number = $("#string-num\\[" + idx + "\\]").val();
              if (!item.options.number) configReady = "";
              item.options.encode = $("#string-encode\\[" + idx + "\\]").val();
              break;
            case "numList":
              item.dataName = $("#numList-dName\\[" + idx + "\\]").val();
              if (!item.dataName) configReady = "";
              item.options.source = $("#numList-src\\[" + idx + "\\]").val();
              if (!item.options.source) configReady = "";
              item.options.deviceType = $("#numList-deviceType\\[" + idx + "\\]").val();
              if (!item.options.deviceType) configReady = "";
              item.options.number = $("#numList-num\\[" + idx + "\\]").val();
              if (!item.options.number) configReady = "";
              item.options.type = $("#numList-type\\[" + idx + "\\]").val();
              item.options.encode = $("#numList-encode\\[" + idx + "\\]").val();
              break;
          }
          dItems[idx]=item;
        });
        // オブジェクト設定を追加
        var cfgobj = [{ObjectContent:{}, options:{}}];
        cfgobj[0].ObjectContent.contentType = $("#contentType").val();
        cfgobj[0].ObjectContent.contentData = dItems;
        cfgobj[0].objectKey = $("#objectKey").val();
        cfgobj[0].objectDescription = $("#objectDescription").val();
        cfgobj[0].objectName = $("#objectName").val();
        cfgobj[0].options.storeInterval = $("#storeInterval").val();
        cfgobj[0].options.storeAsync = $("#storeAsync").is(":checked");
        $("#node-input-configReady").val(configReady);
        //フォームの各要素をobjectに記述し、JSON文字列に変換する。
        try {$("#node-input-configJson").val(JSON.stringify(cfgobj));}
        catch(e) {$("#node-input-configJson").val("");}
      }

      // fileでの設定の場合
      if ($("#node-input-confsel").val() == "fileSet") {
        // 設定は無効
        if (!$("#fileConfig").val()) configReady = "";
        // 設定データを、Nodeプロパティにコピー
        $("#node-input-configJson").val($("#fileConfig").val());

      }
      // 設定完了フラグをセット
      $("#node-input-configReady").val(configReady);

    }
  });

</script>
