<!--
  Copyright JS Foundation and other contributors, http://js.foundation
  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at
  http://www.apache.org/licenses/LICENSE-2.0
  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/html" data-template-name="PLC-Modbus">

    <div class="form-row">
        <label for="node-input-name" >
            <i class="fa fa-tag"></i><span data-i18n="editor.name"></span></label>
        <input type="text" class="form-control" id="node-input-name">
    </div>
    <!-- modbus node（設定Node）の選択-->
    <div class="form-row">
        <label for="node-input-ModbusCom" style= "vertical-align: middle;">
            <span data-i18n="editor.modbusNode"></span>
            <span style="color: #ff0000;">*</span></label>
        <input type="text" style="width: 300px" id="node-input-ModbusCom">
    </div>

    <!-- 隠しのNodeプロパティ -->
    <div class="form-row hide">
        <input type="text" id="node-input-configReady">
    </div>
    
    <!-- Tab, ownself -->
    <div class="red-ui-tabs" id="ui-tabs">
      <ul>
        <li class="red-ui-tab" style="width: 50%;"><a href="#tab-object-property"
          class="nav-link red-ui-tab-label" data-toggle="tab">
          <span data-i18n="editor.tab.object-settings" ></span></a>
        </li>
        <li class="red-ui-tab active" style="width: 50%;"><a href="#tab-dItem-property"
          class="nav-link red-ui-tab-label" data-toggle="tab">
          <span data-i18n="editor.tab.data-settings" ></span></a>
        </li>
      </ul>
    </div>

    <!-- Tab contents -->
    <div class="tab-content">
      
      <!-- tab-object-property starts -->
      <div id="tab-object-property" class="tab-pane">
        <!-- object propertyの設定 -->
        <div class="form-group" style="margin-left: 20px;">
            <div class="form-row">
                <label style="margin-right: 10px;" for="node-input-storeInterval">
                    <span data-i18n="editor.period"></span></label>
                <input type="number" id="node-input-storeInterval" min="0" step="10"
                    value="300" style="display: inline-block; width: auto;">
                <label for="node-input-storeAsync" style="margin-left: 20px;">
                    <span data-i18n="editor.async"></span></label>
                <input type="checkbox" id="node-input-storeAsync"
                    style="display: inline-block; width: auto;" >
            </div>
            <div class="form-row">
                <label style="margin-right: 10px;" for="node-input-objectName">
                    <span data-i18n="editor.objectname"></span></label>
                <input type="text" style="width: 300px" id="node-input-objectName">
            </div>
            <div class="form-row">
                <label style="margin-right: 10px;"
                    for="node-input-objectKey"><span data-i18n="editor.objectKey"></span>
                    <span style="color: #ff0000;">*</span></label>
                <input required="required" class="form-control" type="text" style="width: 300px"
                  id="node-input-objectKey" data-i18n="[placeholder]editor.objectKeyholder">
            </div>
            <div class="form-row">
                <label style="margin-right: 10px;" for="node-input-objectdescription">
                    <span data-i18n="editor.objectDescription"></span></label>
                <input type="text" style="width: 300px" id="node-input-objectDescription">
            </div>
        </div>
      </div>
      <!-- tab-object-property ends -->

      <!-- tab-dItem-property starts -->
      <div id="tab-dItem-property" class="tab-pane active">
          <!-- dataItem propertyの設定 -->
          <div class="form-row">
              <label for="node-input-contentType"><i class="fa fa-tag"></i>
                  <span data-i18n="editor.node-input-contentType"></span></label>
              <input type="text" id="node-input-contentType" value="ModbusPLC">
          </div>
          <div class="form-row node-input-dItemcontainer-row">
              <ol id="node-input-dItemcontainer">
              </ol>
          </div>
      </div>
      <!-- tab-dItem-property ends -->
    </div>

</script>

<script type="text/x-red" data-help-name="PLC-Modbus">
    <p>preparing ia-cloud objects for store to CCS</p>

<h3>Inputs</h3>
<dl class="message-properties">
  TBD
</dl>

<h3>Outputs</h3>
  <dl class="message-properties">
  TBD
  </dl>

<h3>Details</h3>
  <dl class="message-properties">
  TBD
  </dl>
</script>

<script type="text/javascript">

  RED.nodes.registerType('PLC-Modbus',{
    category: 'iaCloud',
    color:"rgb(231, 180, 100)",
    defaults: {
        // node properties
        name: {value:"PLC-Modbus"},
        ModbusCom: {value:"", type:"Modbus-com", required: true},
        // object properties
        storeInterval: {value:"300"},
        storeAsync: {value: false},
        objectName: {value:""},
        objectKey: {value:"", required: true},
        objectDescription: {value:""},
        contentType: {value: "ModbusPLC", required: true},
        // dataItems property
        dataItems: {
            value: [{}],
        },
        // 必須項目が揃っているかのflag、Nodeに赤三角を表示するために必要
        configReady: {value: "", required: true}
    },
    inputs:1,
    outputs:1,
    icon: "ia-cloud.png",  //アイコンはTBD
    label: function() {
        return this.name||this._("Plc-object");
    },
    labelStyle: function() {
        return this.name?"node_label_italic":"";
    },

    oneditprepare: function() {

        const node = this;
        // Locale strings
        const lblBit = node._("editor.bit");
        const lblNum = node._("editor.number");
        const lblStr = node._("editor.string");
        const lblNuml = node._("editor.numList");
        const lblDname = node._("editor.dname");
        const lblAdd = node._("editor.address");
        const lblBitnum = node._("editor.bitNum");
        const lblPos = node._("editor.pos");
        const lblNeg = node._("editor.neg");
        const lblUnit = node._("editor.unit");
        const lblDType = node._("editor.dType");
        const lblUsign = node._("editor.unsigned");
        const lblSign = node._("editor.signed");
        const lblBCD = node._("editor.BCD");
        const lblOff = node._("editor.offset");
        const lblGain = node._("editor.gain");
        const lblSjis = node._("editor.sjis");
        const lblUTF8 = node._("editor.utf");
        const lblEUC = node._("editor.euc");
        const lblWnum = node._("editor.wnumber");

        // editableList item のhtml要素
        // 1行目のデータタイプとデータ名称
        const itemTypefm =`
            <select style="display:inline-block; width:80px;"
                class="itemType">
                <option selected="selected" value="bit" label=${lblBit}></option>
                <option value="number" label=${lblNum}></option>
                <option value="string" label=${lblStr}></option>
                <option value="numList" label=${lblNuml}></option>
            </select>
            <label style="width:90px; display:inline-block; text-align:right;">${lblDname}</label>
            <input required="required" type="text" style="display:inline-block; text-align:left; width:auto;"
                class="dataName" placeholder="${lblDname}">
        `;
        // 2行目以降のプロパティ設定。データタイプ毎に4種類あり、必要に応じてshow(),hide()する。
        const paraForm =`
            <div class="bitFm">
                <span style="display:inline-block; width:30px"> </span>
                <select class="bit-deviceType" 
                    style="width:50px; display:inline-block; text-align:right; padding-right:5px;"">
                    <option selected="selected" value="Coil">Coil</option>
                    <option value="IS">IS</option>
                </select>
                <input required="required" class="bit-add" placeholder="${lblAdd}" type="number" min="0" 
                    style="width:80px; display:inline-block; text-align:right; padding-right:5px;">
                <label style="width:50px; 
                    display:inline-block; text-align:right; margin-left:10px;">${lblBitnum}</label>
                <input required="required" type="number"  min="1" class="bit-num" placeholder="${lblBitnum}"
                    style="width:50px; display:inline-block; text-align:right; padding-right:5px;">
                <select class="bit-logic" style="width:70px; display:inline-block; text-align:right;">
                    <option selected="selected" value= "pos" label="${lblPos}"></option>
                    <option value= "neg" label="${lblNeg}"></option>
                </select>
            </div>
            <div class="numberFm hidden">
                <div style="margin-top:8px;">
                    <span style="display:inline-block; width:30px"> </span>
                    <select class="number-deviceType" 
                        style="width:50px; display:inline-block; text-align:right; padding-right:5px;">
                        <option selected="selected" value="IR">IR</option>
                        <option value="HR">HR</option>
                    </select>
                    <input required="required" type="number" min="0"
                        style="width:80px; display:inline-block; text-align:right; padding-right:5px;"
                        class="number-add" placeholder="${lblAdd}">
                    <select class="number-type" 
                        style="width:70px; display:inline-block; text-align:right; padding-right:5px; margin-left:10px;">
                        <option selected="selected" value="1w">1word</option>
                        <option value="2w-b">2w-b</option>
                        <option value="2w-l">2w-l</option>
                    </select>
                    <select class="number-encode" 
                        style="width:70px; display:inline-block; text-align:right; padding-right:5px;">
                        <option selected="selected" value="unsigned" label=${lblUsign}></option>
                        <option value="signed" label=${lblSign}"></option>
                        <option value="BCD" label=${lblBCD}></option>
                    </select>
                </div>
                <div style="margin-top:8px;">
                    <span style="display:inline-block; width:30px"> </span>
                    <label style="width:50px; display:inline-block; text-align:right;">${lblOff}</label>
                    <input type="number" step="any" class="number-offset" placeholder="${lblOff}"
                        style="width:70px; display:inline-block; text-align:right; padding-right:5px;">                     
                    <label style="width:50px; display:inline-block; text-align:right; margin-left:10px;">${lblGain}</label>
                    <input type="number" step="any" class="number-gain" placeholder="${lblGain}"
                        style="width:70px; display:inline-block; text-align:right; padding-right:5px;">
                    <input type="text" class="number-unit" placeholder="${lblUnit}"
                        style="width:50px; display:inline-block; text-align:right; padding-right:5px;margin-left:20px;">              
                </div>
            </div>
            <div class="stringFm hidden" style="margin-top:8px;">
                <span style="display:inline-block; width:30px"> </span>
                <select class="string-deviceType" 
                    style="width:50px; display:inline-block; text-align:right; padding-right:5px;"> 
                    <option selected="selected" value="IR">IR</option>
                    <option value="HR">HR</option>
                </select>
                <input required="required" type="number"  min="0" class="string-add" placeholder="${lblAdd}"
                    style="width:80px; display:inline-block; text-align:right; padding-right:5px;">
                <label style="width:50px; display:inline-block; text-align:right; margin-left:10px;">${lblWnum}</label>
                <input type="number" min="1" class="string-num" placeholder="${lblWnum}"
                    style="width:50px; display:inline-block; text-align:right; padding-right:5px;">
                <select class="string-encode"
                    style="width:70px; display:inline-block; text-align:right; padding-right:5px;">
                    <option value="sJIS" label=${lblSjis}></option>
                    <option selected="selected" value="utf-8" label=${lblUTF8}></option>
                    <option value="EUC" label=${lblEUC}></option>
                </select>
            </div>
            <div class="numListFm hidden" style="margin-top:8px;">
                <span style="display:inline-block; width:30px"> </span>
                <select class="numList-deviceType" 
                    style="width:50px; display:inline-block; text-align:right; padding-right:5px;">
                    <option selected="selected" value="IR">IR</option>
                    <option value="HR">HR</option>
                </select>
                <input required="required" type="number" min="0" class="numList-add" placeholder="${lblAdd}"
                    style="width:80px; display:inline-block; text-align:right; padding-right:5px;">
                <label style="width:40px; display:inline-block; text-align:right;">${lblWnum}</label>
                <input required="required" type="number" min="1" class="numList-num" placeholder="${lblWnum}"
                    style="width:50px; display:inline-block; text-align:right; padding-right:5px;">
                <select class="numList-type" 
                    style="width:55px; display:inline-block; text-align:right; padding-right:5px;">
                    <option selected="selected" value="1w">1w</option>
                    <option value="2w-b">2wb</option>
                    <option value="2w-l">2wl</option>
                </select>
                <select class="numList-encode"
                    style="width:60px; display:inline-block; text-align:right; padding-right:5px;">
                    <option selected="selected" value="unsigned" label="${lblUsign}"></option>
                    <option value="signed" label="${lblSign}"></option>
                    <option value="BCD" label="${lblBCD}"></option>
                </select>
            </div>
        `;

        // Define editableList.
        $('#node-input-dItemcontainer').css('min-height', '150px').css('min-width', '450px').editableList({
            removable: true,
            sortable: true,
            height: 400,

            // Process when click add button.
            addItem: function(container, index, dItem) {
                let div1 = $('<div></div>').appendTo(container);
                let div2 = $('<div></div>',{style:"margin-top:8px;"}).appendTo(container);
                // 追加ボタンが押されたら、AnEItemは 空{} で呼ばれます。
                if(!dItem.hasOwnProperty("itemType")) {
                    dItem = {
                        itemType:"bit",
                        dataName:"",
                        bit: {deviceType:"Coil", address:"", number:1, logic:"pos"},
                        number: {deviceType:"HR", address:"", type:"1w", encode:"unsigned", offset:0, gain:1, unit:""}, 
                        string: {deviceType:"HR", address:"", encode:"utf-8", number:1}, 
                        numList: {deviceType:"HR", address:"", type:"1w", encode:"unsigned", number:1}
                    };
                };

                $('<span></span>',{class:"index", 
                    style:"display:inline-block;text-align:right; width:30px; padding-right:5px;"})
                    .text((index + 1) + " :")
                    .appendTo(div1);
                $(itemTypefm).appendTo(div1);
                $(paraForm).appendTo(div2);

                if(!(dItem.itemType == "number" | dItem.itemType == "string" | dItem.itemType == "numList"))
                    dItem.itemType = "bit";
                div1.find(".itemType").val(dItem.itemType);

                div1.find(".dataName").val(dItem.dataName);
                // bit type parameters
                div2.find(".bit-deviceType").val(dItem.bit.deviceType);
                div2.find(".bit-add").val(dItem.bit.address);
                div2.find(".bit-num").val(dItem.bit.number);
                div2.find(".bit-logic").val(dItem.bit.logic);
                // number type parameters
                div2.find(".number-deviceType").val(dItem.number.deviceType);
                div2.find(".number-add").val(dItem.number.address);
                div2.find(".number-type").val(dItem.number.type);
                div2.find(".number-encode").val(dItem.number.encode);
                div2.find(".number-offset").val(dItem.number.offset);
                div2.find(".number-gain").val(dItem.number.gain);
                div2.find(".number-unit").val(dItem.number.unit);
                // string type parameters
                div2.find(".string-deviceType").val(dItem.string.deviceType);
                div2.find(".string-add").val(dItem.string.address);
                div2.find(".string-num").val(dItem.string.number);
                div2.find(".string-encode").val(dItem.string.encode);
                // numberList type parameters
                div2.find(".numList-deviceType").val(dItem.numList.deviceType);
                div2.find(".numList-add").val(dItem.numList.address);
                div2.find(".numList-num").val(dItem.numList.number);
                div2.find(".numList-type").val(dItem.numList.type);
                div2.find(".numList-encode").val(dItem.numList.encode);

                // データタイプが変更されたら呼ばれる処理関数を登録
                div1.find(".itemType").change(function(){
                    let type = $(this).val();
                    // 該当するhtml要素を表示、他を隠す。
                    switch(type) {
                        case "bit":
                            div2.find(".bitFm").show();
                            div2.find(".numberFm").hide();
                            div2.find(".stringFm").hide();
                            div2.find(".numListFm").hide();
                            break;
                        case "number":
                            div2.find(".bitFm").hide();
                            div2.find(".numberFm").show();
                            div2.find(".stringFm").hide();
                            div2.find(".numListFm").hide();
                            break;
                        case "string":
                            div2.find(".bitFm").hide();
                            div2.find(".numberFm").hide();
                            div2.find(".stringFm").show();
                            div2.find(".numListFm").hide();
                            break;
                        case "numList":
                            div2.find(".bitFm").hide();
                            div2.find(".numberFm").hide();
                            div2.find(".stringFm").hide();
                            div2.find(".numListFm").show();
                            break;
                    }
                });
                div1.find(".itemType").change();

            },
            // リストの順番が変わったら呼ばれる。
            sortItems: function(items) {
                items.each(function(i, elm){
                    // 番号を降り直し
                    elm.find(".index").text((i + 1) + ":");
                });
            },
            // リストの項目が削除されたら呼ばれる。
            removeItem: function(dItem){
                let items = $('#node-input-dItemcontainer').editableList("items");
                items.each(function(i, elm){
                    // 番号を降り直し
                    elm.find(".index").text((i + 1) + ":");
                });
            }
        });

        // Nodeの設定パラメータを取り出し、editableListに登録
        for (let i=0; i<node.dataItems.length; i++) {
            $("#node-input-dItemcontainer").editableList('addItem',node.dataItems[i]);
        }
    },

    oneditsave: function() {
        const node = this;
        let configReady = "ready";
        let items = $("#node-input-dItemcontainer").editableList('items');

        // データ設定を作成
        node.dataItems = [];

        items.each(function(i, elm){
            let item = {
                itemType: elm.find(".itemType").val(),
                dataName: elm.find(".dataName").val(),
                bit: {          // bit type parameter
                    deviceType: elm.find(".bit-deviceType").val(),
                    address: parseInt(elm.find(".bit-add").val()),
                    number: elm.find(".bit-num").val(),
                    logic: elm.find(".bit-logic").val(),
                },
                number: {       // number type parameters
                    deviceType: elm.find(".number-deviceType").val(),
                    address: parseInt(elm.find(".number-add").val()),
                    type: elm.find(".number-type").val(),
                    encode: elm.find(".number-encode").val(),
                    offset: Number(elm.find(".number-offset").val()),
                    gain: Number(elm.find(".number-gain").val()),
                    unit: elm.find(".number-unit").val(),
                },
                string: {       // string type parameters
                    deviceType: elm.find(".string-deviceType").val(),
                    address: parseInt(elm.find(".string-add").val()),
                    number: parseInt(elm.find(".string-num").val()),
                    encode: elm.find(".string-encode").val(),
                },
                numList: {      // numberList type parameters
                    devideType: elm.find(".numList-deviceType").val(),
                    address: parseInt(elm.find(".numList-add").val()),
                    number: parseInt(elm.find(".numList-num").val()),
                    type: elm.find(".numList-type").val(),
                    encode: elm.find(".numList-encode").val(),
                }
            }
            // 必須propertyが揃っているか？
            if (!item.dataName) configReady = "";
            switch(item.itemType) {
                case "bit":
                    if (!Number.isInteger(item.bit.address)) configReady = "";
                    break;
                case "number":
                    if (!Number.isInteger(item.number.address)) configReady = "";
                    if (!Number.isInteger(item.number.offset)) configReady = "";
                    if (!Number.isInteger(item.number.gain)) configReady = "";
                    break;
                case "string":
                    if (!Number.isInteger(item.string.address)) configReady = "";
                    if (!Number.isInteger(item.string.number)) configReady = "";
                    break;
                case "numList":
                    if (!Number.isInteger(item.numList.address)) configReady = "";
                    if (!Number.isInteger(item.numList.number)) configReady = "";
                    break;
            }
            node.dataItems.push(item);
        });
        // objectKeyはある？
        if (!$("#node-input-objectKey").val()) configReady = "";
         // contentTypeはある？
         if (!$("#node-input-contentType").val()) configReady = "";
        // データ設定が一つはある？
        if (!node.dataItems[0]) configReady = "";
        // 設定完了フラグをセット
        $("#node-input-configReady").val(configReady);
    },

    oneditresize: function(size) {
        // エディタがリサイズされたら
        let height = size.height;
        // Tab以外の部分の高さを引く
        let rows = $("#dialog-form>div:not(.tab-content");
        for (let i=0; i<rows.length; i++) {
            // 非表示要素は省く
            if ($(rows[i]).is(":visible")) height -= $(rows[i]).outerHeight(true);
        }
        // dataItemプロパティTab内の、editableList以外の行の高さを引く
        rows = $("#tab-dItem-property>div:not(.node-input-dItemcontainer-row)");
        for (let i=0; i<rows.length; i++) {
            height -= $(rows[i]).outerHeight(true);
        }
        // editableListのマージンを引く
        const editorRow = $("#tab-dItem-property>div.node-input-dItemcontainer-row");
        height -= (parseInt(editorRow.css("marginTop"))+parseInt(editorRow.css("marginBottom")));
        
        height += 16;   // この意味はわからない。Node-RED core の Change nodeのソースから。

        // editableListの高さを設定。editableListが非表示の時は正しく動作しない。
        $("#node-input-dItemcontainer").editableList('height',height);
    }

  });

</script>
