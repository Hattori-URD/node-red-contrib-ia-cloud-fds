# Modbus機器オブジェクトノード

## ia-cloud-ModbusObj

## 機能概要

このノードは、FlowコンテキストオブジェクトであるModbusリンクオブジェクトを参照し、一定周期あるいは非同期に、ia-cloudオブジェクトを生成し、ia-cloud CCSへストアーするため、ia-cloud接続nodeに対しModbusデータオブジェクトを出力メッセージとして送出する。　
起動時（デプロイ時？）には、自身のプロパティにで指定された、Modbus通信を実行するNodeとのデータリンクを実現するためのFlowコンテキストオブジェクトであるデータリンクオブジェクトに対し、プロッパティで指定されたデータItem情報に従い、必要なエントリーを追加する。起動時（デプロイ時？）に、プロパティにで指定された、Flowコンテキストオブジェクトであるデータリンクオブジェクトが存在しない場合は、例外を発生する。

## 入力メッセージ

* ``payload``: Modbusアドレス格納値に変化があったModbusアドレスの配列  

このメッセージを受けて、データの変化のあったオブジェクトのストアーを行う。

| 名称 | 種別 | 説明 |
|:----------|:-----:|:--------------------|
|"addresses"|[string]|["address 1", "address 2", "adrdess 3", .... "address n"]  

| 名称 | 種別 | 説明 |
|:----------|:-----:|:--------------------|
|"address n"|string|"ユニットアドレス:データアドレス"|

	サンプル
```
 msg.payload = {[
	 "2:4123",
	 "1:4678",
	 "1:1748"
	 ]}
```
## プロパティー

本nodeは以下のプロパティを持つ

| 名称 | 種別 | 説明 |
|:----------|:-----:|:--------------------|
| linkObjName|string|読み出すデータのModbusアドレスと、変化時通知のフラグを格納するFlowコンテキストオブジェクトの名称。デフォルトは、ModbusLinkObj。|
|ストア周期|number|Flowコンテキストオブジェクトよりデータを取得し、ia-cloudオブジェクトを生成しia-cloud CCS ヘストアする周期, S（秒）で指定できる。|
|収集データオブジェクト|object| nodeが生成する ia-cloudオブジェクトの情報|

**収集データオブジェクト**

| 名称 | 種別 | 説明 |
|:----------|:-----:|:--------------------|
|オブジェクトキー|string| ia-cloudオブジェクトのobjectKeyとして使われる。|
|オブジェクトの説明|string| ia-cloudオブジェクトのobjectDiscriptionとして使われる。|
|データitem情報| object| objectContentとして挿入されるオブジェクトを生成するための情報。|

**データitem情報**
以下のオブジェクトの配列(**複数のデータい形式を組み合わせることができる**。)

| 名称 | 種別 | 説明 |
|:----------|:-----:|:--------------------|
|データ名称|string|オブジェクトのデータitemの名称。 ia-cloudデータモデルのdataNameとして使用される。|
|データアドレス| string |データを取得するlinkObjのModbusアドレス。"ユニットアドレス:データアドレス"で表される。|
|データ種別| string |データドレスが示す内容のデータ形式。ビット[列]、数値[列]、文字列|

***ビット[列]***

| 名称 | 種別 | 説明 |
|:----------|:-----:|:--------------------|
|ビット数|number|連続するビットデータの数。 >= 1|
|論理|string | 正論理(1:true,0:false) or 負論理(1:false,0:true)|

***数値[列]***

| 名称 | 種別 | 説明 |
|:----------|:-----:|:--------------------|
|データ数|number|連続する数値データの数。 >= 1|
|単位|string|オブジェクトのデータitemの単位。 ia-cloudデータモデルのunitとして使用される。|
|ワード長|number|データのワード長。　1 or 2。|
|形式|string|数値データの形式。バイナリー、オフセットバイナリー、2の補数、BCD|
|倍率| number|オブジェクトのデータをlinkObjのデータから計算する際の倍率。|
|オフセット| number|オブジェクトのデータをlinkObjのデータから計算する際のオフセット。linkObjのデータ * 倍率 + オフセットとして使われる|

***文字列***

| 名称 | 種別 | 説明 |
|:----------|:-----:|:--------------------|
|データ長|number|連続する文字データのデータ長(Byte数)。 >= 1。エンコードによって、文字数と一致しないので注意。|
|エンコード|string|文字列データのエンコード。　ASCII, sJIS, EUC-JP, UTF-8, のいずれか。|


## 出力メッセージ

* ``msg.store``:ia-cloudに送出されるia-cloudリクエストとなるオブジェクト。ia-cloud-cnct nodeの入力メッセージとなり、 ia-cloudサーバへリクエストとして送出される。

例
```
{
	"objectType": "iaCloudObject",
	"objectKey": "「オブジェクトキー」",
	"objectDiscription": "『オブジェクトの説明』"
	"timeStamp": "2018-07-26T23:59:09+09:00",
	"ObjectContent": {
		"contentType": "iaCloudData",
		"contentData": [{
			"dataName": "「データ名称」",
			"dataValue": 『true』,
			},{
			"dataName": "「データ名称」",
			"dataValue": 『データアドレスの内容 * 倍率 + オフセット』,
			"unit": "「単位」"
			},{
			"dataName": "「データ名称」",
			"dataValue": [(データ * 倍率 + オフセット), (データ * 倍率 + オフセット)...  ]
			"unit": "「単位」"
			}{
			"dataName": "「データ名称」",
			"dataValue": 『デコードされた文字列』
			},
					:
					:
					:
					:
		]
	}
}

```

## リンクデータオブジェクト（Flowコンテキストオブジェクト）　　
本nodeは起動時（デプロイ時？）に、Modbus機器との通信で取得すべきデータのアドレスと変化通知対象フラグが格納された、Flowコンテキストのオブジェクト**.mobusLinkObj**を生成する。（Modbus通信nodeは、その設定に基づきデータを取得して、取得したデータをそのオブジェクトに格納する。）  
本nodeは、必要なタイミングで、このオブジェクトからデータを読み出し、 ia-cloudオブジェクトのJSON文字列を生成し、 ia-cloudプロトコールで ia-cloudサーバへ送出する。

本オブジェクトの基本仕様は、 ia-cloud-FDS-node.PLCLinkObj_doc.mdを参照のこと。

Modbus依存の要素は以下の通り  

| 要素 | 種別 | 説明 |
|:----------|:-----:|:--------------------|
| address | string | "ユニットアドレス:データアドレス"で表現された、Modbusアドレス。ユニットアドレス：データアドレスいずれも10進数文字列表現。|
|notify| boolean |データの変化時に出力メッセージにアドレスを出力するかのフラグ|
|value| number |ModbusDeviceとの通信により取得したデータ。32bitデバイスの場合　-32768〜32767、ビットデバイスの場合 0 or 1。|

ユニットアドレス：  
Modbus RTU、Modbus ASCII の場合はRS485子機アドレス（1〜255）、Modbus TCPの場合はユニット番号（1〜255）

DataLinkObjの例
```
flow.mobusLinkObj = {[
	{
		"address": "2:4123",
		"notify": true,
		"value": 567
	},{
		"address": "1:4678",
		"notify": true,
		"value": 2795
	},{
		"address": "1:1748",
		"notify": false,
		"value": 12
	},
					:
					:
					:
					:
]}
```
