<!--
  Copyright JS Foundation and other contributors, http://js.foundation
  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at
  http://www.apache.org/licenses/LICENSE-2.0
  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.   -->

<script type="text/x-red" data-template-name="PLC-Modbus-AE">

    <div class="form-row">
        <label for="node-input-name" ><i class="fa fa-tag"></i><span data-i18n="editor.name"></span></label>
        <input type="text" class="form-control" id="node-input-name">
    </div>
    <!-- modbus node（設定Node）の選択-->
    <div class="form-row">
        <label for="node-input-ModbusCom" style= "vertical-align: middle;">
            <span data-i18n="editor.modbusNode"></span><span style="color: #ff0000;">*</span></label>
        <input type="text" style="width: 300px" id="node-input-ModbusCom">
    </div>
<hr>

    <!-- 隠しのNodeプロパティ -->
    <div class="form-row hide">
        <input type="text" id="node-input-configReady">
    </div>
    <div class="form-row hide">
        <input type="text" id="node-input-configJson">
    </div>
    
    <!-- Tab, ownself -->
    <div class="red-ui-tabs" id="ui-tabs">
      <ul>
        <li class="red-ui-tab active" style="width: 50%;"><a href="#tab1"
          class="nav-link red-ui-tab-label" data-toggle="tab">
          <span data-i18n="editor.tab.object-settings" /></a>
        </li>
        <li class="red-ui-tab" style="width: 50%;"><a href="#tab2"
          class="nav-link red-ui-tab-label" data-toggle="tab">
          <span data-i18n="editor.tab.data-settings" /></a>
        </li>
      </ul>
    </div>

    <!-- Tab contents -->
    <div class="tab-content">

      <!-- tab1 starts -->
      <div id="tab1" class="tab-pane active">
        <!-- object propertyの設定 -->
        <div class="form-group" style="margin-left: 20px;">
            <div class="form-row">
                <label style="margin-right: 10px;" for="storeInterval">
                    <span data-i18n="editor.period"></span></label>
                <input type="number" id="storeInterval" min="0" step="10"
                    value="300" style="display: inline-block; width: auto;">
                <label for="storeAsync" style="margin-left: 20px;">
                    <span data-i18n="editor.async"></span></label>
                <input type="checkbox" checked="checked" id="storeAsync"
                    style="display: inline-block; width: auto;" disabled='disabled'>
            </div>
            <div class="form-row">
                <label style="margin-right: 10px;" for="objectName">
                    <span data-i18n="editor.objectname"></span></label>
                <input type="text" style="width: 300px" id="objectName">
            </div>
            <div class="form-row">
                <label style="margin-right: 10px;"
                    for="objectKey"><span data-i18n="editor.objectKey"></span>
                    <span style="color: #ff0000;">*</span></label>
                <input class="form-control" type="text" style="width: 300px"
                  id="objectKey" data-i18n="[placeholder]editor.objectKeyholder">
            </div>
            <div class="form-row">
                <label style="margin-right: 10px;"
                    for="objectdescription"><span data-i18n="editor.objectDescription"></span></label>
                <input type="text" style="width: 300px" id="objectDescription">
            </div>
        </div>
      </div>
      <!-- tab1 ends -->

      <!-- tab2 starts -->
      <div id="tab2" class="tab-pane">
        <!-- dataItem propertyの設定 -->
        <div class="form-row">
          <label for="node-config-input-contentType"><i class="fa fa-tag"></i>
              <span data-i18n="editor.contentType"></span></label>
          <input type="text" id="node-config-input-contentType" value="Alarm&Event" disabled="disabled">
        </div>
        <div id="blocks">
          <div class="form-block" id="form_block[0]">

              <div class="form-row">
                <div class="form-inline" id="from_del[0]" >
                  <span style="border-bottom:solid 2px;"><span data-i18n="editor.itemNumber"></span></span>
                  <input type="text" id="dItem[0]" style="width: 30px;" value="1"
                      disabled="disabled">
                  <input type="button" name="del_btn" data-i18n="[value]editor.del"
                      style="margin-left: 30px; width: 70px; display: none;">
                  </div>
              </div>
              <div class="form-row">
                  <div class="form-inline" style="vertical-align: middle;">
                      <label><span data-i18n="editor.address"></span><span style="color: #ff0000;">*</span></label>
                      <select id="deviceType[0]" style="width: 50px;">
                          <option selected="selected" value="Coil">Coil</option>
                          <option value="IS">IS</option>
                          <option value="IR">IR</option>
                          <option value="HR">HR</option>
                      </select>
                      <input type="text" style="margin-right: 10px; width: 80px" id="source[0]">
                      <select style="width: 70px" id="logic[0]">
                          <option selected="selected" value= "pos" data-i18n="editor.pos"></option>
                          <option value= "neg" data-i18n="editor.neg"></option>
                      </select>
                  </div>
              </div>
              <div class="form-row">
                  <label><span data-i18n="editor.AECode"></span></label>
                  <input type="text" style="width: 100px;" id="AnECode[0]">
              </div>
              <div class="form-row">
                  <label><span data-i18n="editor.AEDescription"></span></label>
                  <textarea style="width: 300px" id="AnEdescription[0]" rows="2"></textarea>
              </div>
              <br>
          </div>
        </div>
        <!-- Addボタン -->
        <div class="form-block">
          <input type="button" id="form_add" name="add_btn"  data-i18n="[value]editor.add">
        </div>

      </div>
      <!-- tab2 ends -->
    </div>

</script>


<script type="text/x-red" data-help-name="PLC-Modbus-AE">
    <p>preparing ia-cloud objects for store to CCS</p>

<h3>Inputs</h3>
<dl class="message-properties">
  TBD
</dl>

<h3>Outputs</h3>
  <dl class="message-properties">
  TBD
  </dl>

<h3>Details</h3>
  <dl class="message-properties">
  TBD
  </dl>
</script>

<script type="text/javascript">

  RED.nodes.registerType('PLC-Modbus-AE',{
    category: 'iaCloud',
    color:"rgb(231, 180, 100)",
    defaults: {
        name: {value:"PLC-Modbus-AE"},
        confsel: {value:"ui-config", required: true },
        configJson:{value:"", required: true },
        ModbusCom: {value:"", type:"Modbus-com", required: true},
        // 必須項目が揃っているかのflag、Nodeに赤三角を表示するために必要
        configReady: {value: "", required: true}
    },
    inputs:1,
    outputs:1,
    icon: "ia-cloud.png",
    label: function() {
        return this.name||this._("Plc-object");
    },
    labelStyle: function() {
        return this.name?"node_label_italic":"";
    },

    oneditprepare: function() {

      // データItemの数を保持する変数
      var frm_cnt = 0;

      // 設定データを取り出して、各formに展開する。
      if ($("#node-input-configJson").val()) {

        try{ var conf = JSON.parse($("#node-input-configJson").val());}
        catch(e){ conf = null; }
      }
      //設定データがあったら
      if(conf) {
        $("#storeInterval").val(conf[0].options.storeInterval);
        $("#storeAsync").prop("checked", conf[0].options.storeAsync);
        $("#objectName").val(conf[0].objectName);
        $("#objectKey").val(conf[0].objectKey);
        $("#objectDescription").val(conf[0].objectDescription);

        var dItems = conf[0].ObjectContent.contentData;

        //フォームを一つ保存
        var original = $('#form_block\\[0\\]');

        //一旦フォームオブジェクトをすべて削除
        $(".form-block[id^='form_block']")
            .each(function(index, formObj) {$(formObj).remove();});

        dItems.forEach(function(value, idx){
          original
          .clone()
          .hide()
          .appendTo("#blocks")
          .attr('id', 'form_block[' + idx + ']') // クローンのid属性を変更。
          .end() // 一度適用する
          .find('div, input, textarea, select, label').each(function(index, obj) {
            if ($(obj).attr('id') != null) {
              if($(obj).attr("id").substr(0,5) == "dItem"){
                  $(obj).val("" + (idx + 1));
              }
              $(obj).attr({
                id: $(obj).attr('id').replace(/\[[0-9]+\]$/, '[' + idx + ']')
              });
            }
            if ($(obj).attr('name') != null) {
              $(obj).attr({
                  name: $(obj).attr('name').replace(/\[[0-9]+\]$/, '[' + idx + ']')
                });
            }
            if ($(obj).attr('for') != null) {
              $(obj).attr({
                  for: $(obj).attr('for').replace(/\[[0-9]+\]$/, '[' + idx + ']')
              });
            }
        });
        $("#deviceType\\[" + idx + "\\]").val(value.options.deviceType);
        $("#source\\[" + idx + "\\]").val(value.options.source);
        $("#logic\\[" + idx + "\\]").val(value.options.logic);
        $("#AnECode\\[" + idx + "\\]").val(value.dataValue.AnECode);
        $("#AnEdescription\\[" + idx + "\\]").val(value.dataValue.AnEdescription);

        var block = $('#form_block\\[' + idx + '\\]');
        if (idx != 0) block.find('input[name="del_btn"]').show();
        block.slideDown('slow');
        frm_cnt = idx;
        });
      }

      //追加ボタンが押されたら
      $("#form_add").off("click");
      $("#form_add").on("click", function() {

        var original = $('#form_block\\[' + frm_cnt + '\\]');
        frm_cnt++;
        original
        .clone()
        .hide()
        .insertAfter(original)
        .attr('id', 'form_block[' + frm_cnt + ']'); // クローンのid属性を変更。
        var clone = $('#form_block\\[' + frm_cnt + '\\]');
        clone.find('div, input, textarea, select, label').each(function(idx, obj) {
          if ($(obj).attr('id') != null) {
            if($(obj).attr("id").substr(0,5) == "dItem"){
                $(obj).val("" + (frm_cnt + 1));
            }
            $(obj).attr({
              id: $(obj).attr('id').replace(/\[[0-9]+\]$/, '[' + frm_cnt + ']')
            });
          }
          if ($(obj).attr('name') != null) {
            $(obj).attr({
              name: $(obj).attr('name').replace(/\[[0-9]+\]$/, '[' + frm_cnt + ']')
             });
          }
          if ($(obj).attr('for') != null) {
            $(obj).attr({
              for: $(obj).attr('for').replace(/\[[0-9]+\]$/, '[' + frm_cnt + ']')
            });
          }
        });
        clone.find('input[name="del_btn"]').show();
        clone.slideDown('fast');
      });

      //削除ボタンが押されたら
      $("#blocks").off('click', 'input[name="del_btn"]');
      $("#blocks").on('click', 'input[name="del_btn"]', function() {
        var removeObj = $(this).parents(".form-block");
        removeObj.fadeOut('fast', function() {
          removeObj.remove();
          // 番号振り直し
          frm_cnt = 0;
          $(".form-block[id^='form_block']").each(function(index, formObj) {
            if ($(formObj).attr('id') != 'form_block[0]') {
              frm_cnt++;
              $(formObj)
                .attr('id', 'form_block[' + frm_cnt + ']') // id属性を変更。
                .find('div, input, textarea, select, label').each(function(idx, obj) {
                 if ($(obj).attr('id') != null) {
                    if($(obj).attr("id").substr(0,5) == "dItem"){
                          $(obj).val("" + (frm_cnt + 1));
                    }
                    $(obj).attr({
                      id: $(obj).attr('id').replace(/\[[0-9]+\]$/,'['+frm_cnt+']')
                    });
                  }
                  if ($(obj).attr('name') != null) {
                    $(obj).attr({
                      name: $(obj).attr('name').replace(/\[[0-9]+\]$/,'['+frm_cnt+']')
                    });
                  }
                  if ($(obj).attr('for') != null) {
                    $(obj).attr({
                      for: $(obj).attr('for').replace(/\[[0-9]+\]$/,'['+frm_cnt+']')
                    });
                  }
                });
            }
          });
        });
      });
    },

    oneditsave: function() {

        var configReady = "ready";
        // UI-configの場合

        if (!$("#objectKey").val()) configReady = "";
        // データ設定を作成
        var dItems = [];
        $(".form-block[id^='form_block']").each(function(idx, obj){
            var item ={commonName: "Alarm&Event", dataValue: {}, options:{}};

            item.options.deviceType = $("#deviceType\\[" + idx + "\\]").val();
            item.options.source = $("#source\\[" + idx + "\\]").val();
            if (!item.options.source) configReady = "";
            item.options.logic = $("#logic\\[" + idx + "\\]").val();
            item.dataValue.AnECode = $("#AnECode\\[" + idx + "\\]").val();
            item.dataValue.AnEdescription = $("#AnEdescription\\[" + idx + "\\]").val();

            dItems[idx]=item;
        });
        // オブジェクト設定を追加
        var cfgobj = [{ObjectContent:{}, options:{}}];
        cfgobj[0].ObjectContent.contentType = "Alarm&Event";
        cfgobj[0].ObjectContent.contentData = dItems;
        cfgobj[0].objectKey = $("#objectKey").val();
        cfgobj[0].objectDescription = $("#objectDescription").val();
        cfgobj[0].objectName = $("#objectName").val();
        cfgobj[0].options.storeInterval = $("#storeInterval").val();
        cfgobj[0].options.storeAsync = $("#storeAsync").is(":checked");
        $("#node-input-configReady").val(configReady);
        //フォームの各要素をobjectに記述し、JSON文字列に変換する。
        try {$("#node-input-configJson").val(JSON.stringify(cfgobj));}
        catch(e) {$("#node-input-configJson").val("")}
      
        // 設定完了フラグをセット
        $("#node-input-configReady").val(configReady);

    }
  });

</script>
