<!--
  Copyright JS Foundation and other contributors, http://js.foundation
  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at
  http://www.apache.org/licenses/LICENSE-2.0
  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.   -->

<script type="text/html" data-template-name="PLC-Modbus-AE">

    <div class="form-row">
        <label for="node-input-name" ><i class="fa fa-tag"></i><span data-i18n="editor.name"></span></label>
        <input type="text" class="form-control" id="node-input-name">
    </div>
    <!-- modbus node（設定Node）の選択-->
    <div class="form-row">
        <label for="node-input-ModbusCom" style= "vertical-align: middle;">
            <span data-i18n="editor.modbusNode"></span><span style="color: #ff0000;">*</span></label>
        <input type="text" style="width: 300px" id="node-input-ModbusCom">
    </div>

    <!-- 隠しのNodeプロパティ -->
    <div class="form-row hide">
        <input type="text" id="node-input-configReady">
    </div>
    
    <!-- Tab, ownself -->
    <div class="red-ui-tabs" id="ui-tabs">
      <ul>
        <li class="red-ui-tab" style="width: 50%;"><a href="#tab-object-property"
          class="nav-link red-ui-tab-label" data-toggle="tab">
          <span data-i18n="editor.tab.object-settings" ></span></a>
        </li>
        <li class="red-ui-tab active" style="width: 50%;"><a href="#tab-AnE-property"
          class="nav-link red-ui-tab-label" data-toggle="tab">
          <span data-i18n="editor.tab.data-settings" ></span></a>
        </li>
      </ul>
    </div>

    <!-- Tab contents -->
    <div class="tab-content">

      <!-- tab-object-property starts -->
      <div id="tab-object-property" class="tab-pane">
        <!-- object propertyの設定 -->
        <div class="form-group" style="margin-left: 20px;">
            <div class="form-row">
                <label style="margin-right: 10px;" for="node-input-storeInterval">
                    <span data-i18n="editor.period"></span></label>
                <input type="number" id="node-input-storeInterval" min="0" step="10"
                    value="300" style="display: inline-block; width: auto;">
                <label for="node-input-storeAsync" style="margin-left: 20px;">
                    <span data-i18n="editor.async"></span></label>
                <input type="checkbox" checked="checked" id="node-input-storeAsync"
                    style="display: inline-block; width: auto;" disabled='disabled'>
            </div>
            <div class="form-row">
                <label style="margin-right: 10px;" for="node-input-objectName">
                    <span data-i18n="editor.objectname"></span></label>
                <input type="text" style="width: 300px" id="node-input-objectName">
            </div>
            <div class="form-row">
                <label style="margin-right: 10px;"
                    for="node-input-objectKey"><span data-i18n="editor.objectKey"></span>
                    <span style="color: #ff0000;">*</span></label>
                <input class="form-control" type="text" style="width: 300px"
                  id="node-input-objectKey" data-i18n="[placeholder]editor.objectKeyholder">
            </div>
            <div class="form-row">
                <label style="margin-right: 10px;"
                    for="node-input-objectdescription"><span data-i18n="editor.objectDescription"></span></label>
                <input type="text" style="width: 300px" id="node-input-objectDescription">
            </div>
        </div>
      </div>
      <!-- tab-object-property ends -->

      <!-- tab-AnE-property starts -->
      <div id="tab-AnE-property" class="tab-pane active">
        <!-- dataItem propertyの設定 -->
        <div class="form-row">
            <label for="contentType">
                <span data-i18n="editor.contentType"></span></label>
            <input type="text" id="contentType" value="Alarm&Event" disabled="disabled">
        </div>
        <div class="form-row node-input-AnEcontainer-row">
            <ol id="node-input-AnEcontainer">
            </ol>
        </div>
      </div>  
      <!-- tab-AnE-property ends -->      
    </div>

</script>


<script type="text/x-red" data-help-name="PLC-Modbus-AE">
    <p>preparing ia-cloud objects for store to CCS</p>

<h3>Inputs</h3>
<dl class="message-properties">
  TBD
</dl>

<h3>Outputs</h3>
  <dl class="message-properties">
  TBD
  </dl>

<h3>Details</h3>
  <dl class="message-properties">
  TBD
  </dl>
</script>

<script type="text/javascript">

RED.nodes.registerType('PLC-Modbus-AE',{
    category: 'iaCloud',
    color:"rgb(231, 180, 100)",
    defaults: {
        // node properties
        name: {value:"PLC-Modbus-AE"},
        ModbusCom: {value:"", type:"Modbus-com", required: true},
        // object properties
        storeInterval: {value:"300"},
        storeAsync: {value: true},
        objectName: {value:""},
        objectKey: {value:""},
        objectDescription: {value:""},
        // AnEItem property
        AnEItems:{value:[{deviceType:"Coil", address:0, logic: "pos", AneCode:"", AnEDescription:""}], required: true},

        // 必須項目が揃っているかのflag、Nodeに赤三角を表示するために必要
        configReady: {value: "", required: true}
    },
    inputs:1,
    outputs:1,
    icon: "ia-cloud.png",
    label: function() {
        return this.name||this._("Plc-object");
    },
    labelStyle: function() {
        return this.name?"node_label_italic":"";
    },

    oneditprepare: function() {

        const node = this;
        // Locale strings
        const address = node._("editor.address");
        const pos = node._("editor.pos");
        const neg = node._("editor.neg");
        const AnECode = node._("editor.AECode");
        const AnEDesc = node._("editor.AEDescription");

        // Define editableList.
        $('#node-input-AnEcontainer').css('min-height', '150px').css('min-width', '450px').editableList({
            removable: true,
            sortable: true,
            height: 180,

            // Process when click add button.
            addItem: function(container, index, AnEItem) {
                const row1 = $('<div></div>').appendTo(container);
                const row2 = $('<div></div>',{style:"margin-top:8px;"}).appendTo(container);
                let element;

                // 追加ボタンが押されたら、AnEItemは 空{} で呼ばれます。
                if(!AnEItem.hasOwnProperty("deviceType")) {
                    AnEItem = {deviceType:"Coil", address:0, logic: "pos", AneCode:"", AnEDescription:""}
                };
                $('<span></span>',{class:"index", style:"display:inline-block;text-align:right; width:30px; padding-right:10px;"})
                    .text((index + 1) + " :")
                    .appendTo(row1);
                element = $('<select/>',{class:"node-input-device-type",style:"width:50px; margin-right:10px;"}).appendTo(row1);
                element.append($("<option></option>").val("Coil").text("Coil"));
                element.append($("<option></option>").val("IS").text("IS"));
                element.append($("<option></option>").val("HR").text("HR"));
                element.append($("<option></option>").val("IR").text("IR"));
                element.val(AnEItem.deviceType);
                
                element = $('<input></input>',
                    {class:"node-input-address",type:"number",min:"0",setp:"1",style: "width:100px; margin-right:20px", placeholder: address})
                    .appendTo(row1);
                element.val(AnEItem.address);
                
                element = $('<select/>',{class:"node-input-logic",style:"width:80px; margin-right:10px;"}).appendTo(row1);
                element.append($("<option></option>").val("pos").text(pos));
                element.append($("<option></option>").val("neg").text(neg));                
                element.val(AnEItem.logic);

                $('<span></span>',{style:"display:inline-block;text-align:right; width:30px; padding-right:10px;"})
                    .appendTo(row2);
                element = $('<input></input>',{class:"node-input-AnECode",type:"text", style: "width:90px; margin-right:10px", placeholder: AnECode})
                    .appendTo(row2);
                element.val(AnEItem.AnECode);
                element = $('<textarea></textarea>',{class:"node-input-AnEDescription",rows:"1", style: "width:240px;", placeholder: AnEDesc})
                    .appendTo(row2);
                element.val(AnEItem.AnEDescription);
            },
            sortItems: function(items) {
                items.each(function(i, elm){
                    elm.find(".index").text((i + 1) + ":");
                });
            },
            removeItem: function(dItem){
                let items = $('#node-input-AnEcontainer').editableList("items");
                items.each(function(i, elm){
                    elm.find(".index").text((i + 1) + ":");
                });
            }

        });

        // 開始時にeditableListを構成します。
        for (let i=0; i<node.AnEItems.length; i++) {
            $("#node-input-AnEcontainer").editableList('addItem',node.AnEItems[i]);
        }
    },

    oneditsave: function() {

        const node = this;
        let configReady = "ready";
        let items = $("#node-input-AnEcontainer").editableList('items');

        // A＆Eデータ設定を作成
        node.AnEItems = [];
        items.each(function(i, elm){
            let item = {
                deviceType: elm.find(".node-input-device-type").val(),
                address: parseInt(elm.find(".node-input-address").val()),
                logic: elm.find(".node-input-logic").val(),
                AnECode: elm.find(".node-input-AnECode").val(),
                AnEDescription: elm.find(".node-input-AnEDescription").val()
            }
            // アドレスは数値？
            if (!Number.isInteger(item.address)) configReady = "";
            node.AnEItems.push(item);
        });

        // objectKeyはある？
        if (!$("#node-input-objectKey").val()) configReady = "";
        // A&Eデータ設定はある？
        if (!node.AnEItems) configReady = "";
        // 設定完了フラグをセット
        $("#node-input-configReady").val(configReady);

    },
    oneditresize: function(size) {
        // エディタがリサイズされたら
        let height = size.height;
        // Tab以外の部分の高さを引く
        let rows = $("#dialog-form>div:not(.tab-content");
        for (let i=0; i<rows.length; i++) {
            // 非表示要素は省く
            if ($(rows[i]).is(":visible")) height -= $(rows[i]).outerHeight(true);
        }
        // AnEプロパティTab内の、editableList以外の行の高さを引く
        rows = $("#tab-AnE-property>div:not(.node-input-AnEcontainer-row)");
        for (let i=0; i<rows.length; i++) {
            height -= $(rows[i]).outerHeight(true);
        }
        // editableListのマージンを引く
        const editorRow = $("#tab-AnE-property>div.node-input-AnEcontainer-row");
        height -= (parseInt(editorRow.css("marginTop"))+parseInt(editorRow.css("marginBottom")));
        
        height += 16;   // この意味はわからない。Node-RED core の Change nodeのソースから。

        // editableListの高さを設定。editableListが非表示の時は正しく動作しない。
        $("#node-input-AnEcontainer").editableList('height',height);
    }
});

</script>