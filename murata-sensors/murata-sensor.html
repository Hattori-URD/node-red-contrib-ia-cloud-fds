<!--
  Copyright JS Foundation and other contributors, http://js.foundation
  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at
  http://www.apache.org/licenses/LICENSE-2.0
  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/html" data-template-name="murata-sensor">

    <!-- modbus node（設定Node）の選択-->
    <div class="form-row node-block">
        <label for="node-input-murataCom" style= "vertical-align: middle;">
            <span data-i18n="editor.murataCom"></span></label>
        <input type="text" style="width: 300px" id="node-input-murataCom">
    </div>
    <div class="form-row node-block">
        <input type="text" style="display: none;" id="node-input-confsel" value="UI">
        <input type="radio" style="display: inline-block; width: auto; vertical-align: top;" name="configSel" id="node-input-UIConf" value="UI" checked="checked">
        <label style="width: 40%;" for="node-input-UIConf" data-i18n="editor.UIConf"></label>
        <input type="radio" style="display: inline-block; width: auto; vertical-align: top;" name="configSel" id="node-input-fileConf" value="file">
        <label style="width: 40%;" for="node-input-fileConf" data-i18n="editor.fileConf"></label>
        <hr>  
    </div>  

    <div class="form-row" style="margin-left: 20px;" id="node-row-fileSet">
        <div>
            <input type="file" accept="application/json" id="select_config_file">
        </div>
        <div>
            <input type="text" id="node-input-configfile" style="width: 400px;" data-i18n="[placeholder]editor.fileName">
        </div>
        <div>    
            <textarea id="node-input-configObjects" cols="80" rows="20" style="width: 400px;" 
                required="required" data-i18n="[placeholder]editor.fileContent"></textarea>
        </div>
    </div>
    <div class="row" style="margin-left: 20px;" id="node-row-UISet">
        <!-- Tab, ownself -->
        <div class="form-row">
            <ul style="min-width: 500px; margin-bottom: 20px;" id="murata-sensor-tabs">
            </ul>
        </div>

        <!-- Tab contents -->
        <div id="murata-sensor-tabs-content" style="min-height:250px;">

            <!-- tab1 starts for dataObject-->
            <div id="tab-object-settings" style="display:none">

                <!-- objectの設定 -->
                <div class="form-row">
                    <label for="node-input-storeInterval" style="width:150px;">
                        <span data-i18n="editor.period"></span></label>
                    <select style="width: 80px" id="node-input-storeInterval">
                        <option value="15s" data-i18n="editor.15s"></option>
                        <option value="30s" data-i18n="editor.30s"></option>
                        <option value="1m" data-i18n="editor.1m"></option>
                        <option value="5m" data-i18n="editor.5m"></option>
                        <option value="10m" data-i18n="editor.10m"></option>
                        <option value="15m" data-i18n="editor.15m"></option>
                        <option value="30m" data-i18n="editor.30m"></option>
                        <option selected="selected" value="1h" data-i18n="editor.1h"></option>
                        <option value="2h" data-i18n="editor.2h"></option>
                        <option value="6h" data-i18n="editor.6h"></option>
                        <option value="12h" data-i18n="editor.12h"></option>
                        <option value="24h" data-i18n="editor.24h"></option>
                    </select>
                </div>
                <div class="form-row">
                    <label 
                        for="node-input-objectKey" style="width:150px;"><span data-i18n="editor.objectKey"></span></label>
                    <input class="form-control" type="text" style="width: 300px" required="required"
                      id="node-input-objectKey" data-i18n="[placeholder]editor.objectKeyholder">
                </div>
                <div class="form-row">
                    <label 
                        for="node-input-sensorId" style="width:150px;"><span data-i18n="editor.sensorId"></span></label>
                    <input class="form-control" type="text" style="width: 300px" required="required"
                      id="node-input-sensorId" data-i18n="[placeholder]editor.sensorIdholder">
                </div>
                <div class="form-row">
                    <label 
                        for="node-input-objectDescription" style="width:150px;"><span data-i18n="editor.objectDescription"></span></label>
                    <input type="text" style="width: 300px" id="node-input-objectDescription">
                </div>
            </div>
            <!-- tab1 ends -->

            <!-- tab2 starts for alarmObject-->
            <div id="tab-dataItem-settings" style="display:none">

                <!-- dataItemの設定 -->
                <div id="tab-dItem-property">
                    <!-- dataItem propertyの設定 -->
                    <div class="form-row" style="margin-top:8px;">
                        <label for="node-input-contentType"><span data-i18n="editor.contentType"></span></label>
                        <input type="text" id="node-input-contentType" value="iaCloudData">
                    </div>
                    <div class="form-row">
                        <label for="node-input-enableFFT" style="width:auto;"><span data-i18n="editor.enableFFT"></span></label>
                        <input type="checkbox" id="node-input-enableFFT" style="width:auto;">
                    </div>          
                    <div class="dItem-container-row">
                        <ol id="dItem-container">
                        </ol>
                    </div>
                </div>
            </div>
            <!-- tab2 ends -->
        </div>
    </div>

    <div class="node-block">
        <hr>
        <div class="form-row">
            <label for="node-input-name" ><span data-i18n="editor.name"></span></label>
            <input type="text" class="form-control" id="node-input-name">
        </div>
        <div class="form-row">
            <label for="node-input-autoConf" style="width:auto;"><span data-i18n="editor.autoConf"></span></label>
            <input type="checkbox" id="node-input-autoConf" style="display: inline-block; width: auto; margin-left:5px;">
        </div>
        <!-- 隠しのNodeプロパティ -->
        <div class="form-row hide">
            <input type="text" id="node-input-configReady">
        </div>
    </div>
</script>

<script type="text/javascript">

    RED.nodes.registerType('murata-sensor',{
        category: 'iaCloud',
        color:"rgb(231, 180, 100)",
        defaults: {
            name: {value:""},
            confsel: {value:"UI"},
            configObjects: {value:""},
            storeInterval: {value: "1h"},
            objectKey: {value:""},
            objectDescription:{value: ""},
            sensorId:{value: ""},
            murataCom: {value:"", type:"murata-com", required: true},
            autoConf: {value: false},
            enableFFT: {value:false},
            contentType: {value:"iaCloudData"},
            itemList: {value:[
                {dItem: "rms", dataName: "", fft: false},
                {dItem: "sharpness", dataName: "", fft: false},
                {dItem: "bttry", dataName: "", fft: false},
                {dItem: "temp", dataName: "", fft: false},
                {dItem: "rssi", dataName: "", fft: false},
                {dItem: "freq1", dataName: "", fft: true},
                {dItem: "acce1", dataName: "", fft: true},
                {dItem: "freq2", dataName: "", fft: true},
                {dItem: "acce2", dataName: "", fft: true},
                {dItem: "freq3", dataName: "", fft: true},
                {dItem: "acce3", dataName: "", fft: true},
                {dItem: "freq4", dataName: "", fft: true},
                {dItem: "acce4", dataName: "", fft: true},
                {dItem: "freq5", dataName: "", fft: true},
                {dItem: "acce5", dataName: "", fft: true}
            ], required: true},
            configReady: {value: "", required: true}
        },
        inputs:1,
        outputs:1,
        icon: "ia-cloud.png",  //アイコンはTBD

        label: function() {
            return this.name||this._("editor.defaultName");
        },
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        },
        paletteLabel: function() {
            return this._("editor.palletLabel") || "murata acc-sensor";
        },

        oneditprepare: function() {
            let node = this;

            $('input[name="configSel"]:radio').change(function () {
                if ($('#node-input-UIConf').prop('checked')) {
                    $('#node-row-UISet').show();
                    $('#node-row-fileSet').hide();
                    $('#node-input-confsel').val('UI');
                } else {
                    $('#node-row-fileSet').show();
                    $('#node-row-UISet').hide();
                    $('#node-input-confsel').val('file');
                }
            });
            if ($('#node-input-confsel').val() === 'UI') {
                $('#node-input-UIConf').prop('checked', true);
            } else {
                $('#node-input-fileConf').prop('checked', true);
            }
            $('input[name="configSel"]:radio').change();

            $('#select_config_file').on('change', function () {
                const file = this.files[0];
                if (file !== null) {
                    $('#node-input-configfile').val(file.name);
                    const reader = new FileReader();
                    reader.readAsText(file, 'UTF-8');
                    reader.onload = function () {
                        $('#node-input-configObjects').val(reader.result);
                    };
                }
            });
            const lbldName = node._("editor.dataName");
            const dNameList = {
                rms: node._("editor.rms"),
                sharpness: node._("editor.sharpness"),
                bttry: node._("editor.bttry"),
                temp: node._("editor.temp"),
                rssi: node._("editor.rssi"),
                freq1: node._("editor.freq1"),
                acce1: node._("editor.acce1"),
                freq2: node._("editor.freq2"),
                acce2: node._("editor.acce2"),
                freq3: node._("editor.freq3"),
                acce3: node._("editor.acce3"),
                freq4: node._("editor.freq4"),
                acce4: node._("editor.acce4"),
                freq5: node._("editor.freq5"),
                acce5: node._("editor.acce5")
            }
            // editableList item のhtml要素
            // 1行目のデータ名称、動作、正逆設定
            const paraForm =`
                <label class="dItem" style="width:80px; display:inline-block; text-align: right;">${dNameList["rms"]}</label>
                <label style="width:70px; display:inline-block; text-align: right; margin-left: 20px;">${lbldName}</label>
                <input class="dataName"" placeholder="${lbldName}" type="text" required="required" 
                    style="width:150px; display:inline-block; text-align:left; margin-right:20px;">
                
            `;
            // Tab
            const tabs = RED.tabs.create({
              id: 'murata-sensor-tabs',
              onchange(tab) {
                $('#murata-sensor-tabs-content').children().hide();
                $("#" + tab.id).show();
              },
            });
            tabs.addTab({
              id: 'tab-object-settings',
              label: this._('editor.tab.object-settings'),
            });
            tabs.addTab({
              id: 'tab-dataItem-settings',
              label: this._('editor.tab.data-settings'),
            });

            // Define editableList.
            $("#dItem-container").css('min-height','150px').css('min-width','450px').editableList({
                
                addButton: false,
                sortable: false,
                removable: false,
                height: 320,
                
                addItem: function(container,index,item) {

                    // add UI row
                    let div = $('<div></div>').appendTo(container);
                    $('<span></span>',{class:"index", 
                        style:"display:inline-block;text-align:right; width:30px; padding-right:5px;"})
                        .text((index + 1) + " :")
                        .appendTo(div);
                    // add UI form
                    div.append(paraForm);

                    // if item is empty
                    if(!item.dataName) {
                        item.dataName = dNameList[item.dItem];
                    }
                    div.find(".dItem").text(item.dataName);
                    div.find(".dataName").val(item.dataName);
                },
            });

            $("#node-input-enableFFT").change(function(){
                // remove all items, once
                $("#dItem-container").editableList('empty');
                // set propertoes back to the editableList 
                for (let i=0;i<node.itemList.length;i++) {
                    let item = node.itemList[i];
                    if ($("#node-input-enableFFT").prop("checked") || !item.fft) {
                        $("#dItem-container").editableList('addItem',item);
                    }
                }
            });

            // set propertoes back to the editableList at the first
            for (let i=0;i<node.itemList.length;i++) {
                let item = node.itemList[i];
                if ($("#node-input-enableFFT").prop("checked") || !item.fft) {
                    $("#dItem-container").editableList('addItem',item);
                }
            }
        },

        oneditsave: function() {
            let node = this;
            let configReady = "ready";
            // UI configuration
            if ($("#node-input-UIConf").prop("checked")) {
                let items = $("#dItem-container").editableList('items');
console.log("koko");
                // set back data name form html elements
                items.each(function(i, elm){
                    node.itemList[elm.find(".dItem")] =  elm.find(".dataName").val();
                });
                // objectKey & sesorId are required
                if (!$("#node-input-objectKey").val()) configReady = "";
                if (!$("#node-input-sensorId").val()) configReady = "";
            // file configration
            } else{
                // configration JSON is required
                if (!$("#node-input-configObjects").val()) configReady = "";
            }
            // 設定完了フラグをセット
            $("#node-input-configReady").val(configReady);
        },

        oneditresize: function(size) {
            // エディタがリサイズされたら

            // Is the editableList tab visible ?
            if ($("#tab-dItem-property").is(":visible")) {

                let height = size.height;

                // node name block height
                let rows = $(".node-block");
                for (let i=0; i<rows.length; i++) {
                    height -= $(rows[i]).outerHeight(true);
                }
                // editableList以外の行の高さを引く
                rows = $("#tab-dItem-property>*:not(.dItem-container-row)");
                for (let i=0; i<rows.length; i++) {
                    height -= $(rows[i]).outerHeight(true);
                }
                // タブの部分の高さ（大体）
                height -= 60;

                // editableListのマージンを引く
                const editorRow = $("#tab-dItem-property>div.dItem-container-row");
                height -= (parseInt(editorRow.css("marginTop"))+parseInt(editorRow.css("marginBottom")));

                // editableListの高さを設定。editableListが非表示の時は正しく動作しない。
                $("#dItem-container").editableList('height',height);

            }
            
        }
    });

</script>