<!--
  Copyright JS Foundation and other contributors, http://js.foundation
  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at
  http://www.apache.org/licenses/LICENSE-2.0
  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/x-red" data-template-name="tmp-ctrl-omron-AE">

    <div class="form-row">
        <label for="node-input-name" ><i class="fa fa-tag"></i><span data-i18n="editor.name"></span></label>
        <input type="text" class="form-control" id="node-input-name">
    </div>
    <!-- modbus node（設定Node）の選択-->
    <div class="form-row">
        <label for="node-input-ModbusCom" style= "vertical-align: middle;">
            <span data-i18n="editor.modbusNode"></span><span style="color: #ff0000;">*</span></label>
        <input type="text" style="width: 300px" id="node-input-ModbusCom">
    </div>

    <!-- 隠しのNodeプロパティ -->
    <div class="form-row hide">
        <input type="text" id="node-input-configReady">
    </div>
    <div class="form-row hide">
        <input type="text" id="node-input-configJson">
    </div>

    <!-- UIでの設定 -->
    <div id="ui-config">
      <!-- Tab, ownself -->
      <div class="red-ui-tabs" id="ui-tabs">
        <ul>
          <li class="red-ui-tab active" style="width: 50%;"><a href="#tab1"
            class="nav-link red-ui-tab-label" data-toggle="tab">
            <span data-i18n="editor.tab.object-config" /></a>
          </li>
          <li class="red-ui-tab" style="width: 50%;"><a href="#tab2"
            class="nav-link red-ui-tab-label" data-toggle="tab">
            <span data-i18n="editor.tab.AnE-config" /></a>
          </li>
        </ul>
      </div>

      <!-- Tab contents -->
      <div class="tab-content">

        <!-- tab1 starts for Object configration-->
        <div id="tab1" class="tab-pane active">
          <!-- アラームobjectの設定 -->
          <div class="form-group">
              <div class="form-row">
                  <label for="storeInterval">
                      <span data-i18n="editor.period"></span></label>
                  <input type="number" id="storeInterval" min="0" step="10"
                      value="300" style="display: inline-block; width: auto;">
                  <label for="storeAsync" style="margin-left: 20px;">
                      <span data-i18n="editor.async"></span></label>
                  <input type="checkbox" checked="checked" id="storeAsync"
                      style="display: inline-block; width: auto;" >
              </div>
              <div class="form-row">
                  <label for="objectName">
                      <span data-i18n="editor.objectname"></span></label>
                  <input type="text" style="width: 300px" id="objectName">
              </div>
              <div class="form-row">
                  <label 
                      for="objectKey"><span data-i18n="editor.objectKey"></span>
                      <span style="color: #ff0000;">*</span></label>
                  <input class="form-control" type="text" style="width: 300px"
                   id="objectKey" data-i18n="[placeholder]editor.objectKeyholder">
              </div>
              <div class="form-row">
                  <label 
                      for="objectdescription"><span data-i18n="editor.objectDescription"></span></label>
                  <input type="text" style="width: 300px" id="objectDescription">
              </div>
          </div>
        </div>
        <!-- tab1 ends -->

        <!-- tab2 starts for alarm data-->
        <div id="tab2" class="tab-pane">
          <!-- アラームItemの設定 -->
          <div class="form-row">
            <label for="contentType"><span data-i18n="editor.contentType"></span></label>
            <input type="text" style="width: 300px" id="contentType" value="Alarm&Event">
          </div>
          <div id="blocks">
              <div class="form-block" id="AnE_block[0]">
                  <div class="form-row" id="AnE_del[0]" >
                      <span style="border-bottom:solid 2px;"><span data-i18n="editor.itemNumber"></span></span>
                      <input type="text" id="AnEItem[0]" style="width: 30px;" value="1"
                          disabled="disabled">
                      <input type="button" id="del_btn[0]" data-i18n="[value]editor.del"
                          style="margin-left: 30px; width: 70px; display: none;">
                  </div>
                  <div class="form-row">
                      <label><span data-i18n="editor.AnE"></span><span style="color: #ff0000;">*</span></label>
                      <select id="dataSelect[0]" style="width: 150px;">
                          <option value="hh" data-i18n="editor.hh"></option>
                          <option value="ad" data-i18n="editor.ad"></option>
                          <option value="hs" data-i18n="editor.hs"></option>
                          <option selected="selected" value="se" data-i18n="editor.se"></option>
                          <option value="ct1" data-i18n="editor.ct1"></option>
                          <option value="ct2" data-i18n="editor.ct2"></option>
                          <option value="alm1" data-i18n="editor.alm1"></option>
                          <option value="alm2" data-i18n="editor.alm2"></option>
                          <option value="alm3" data-i18n="editor.alm3"></option>
                          <option value="evt1" data-i18n="editor.evt1"></option>
                          <option value="evt2" data-i18n="editor.evt2"></option>
                          <option value="evt3" data-i18n="editor.evt3"></option>
                          <option value="evt4" data-i18n="editor.evt4"></option>
                      </select>
                  </div>
                  <div class="form-row">
                      <label><span data-i18n="editor.AECode"></span></label>
                      <input type="text" style="width: 150px;" id="AnECode[0]">
                  </div>
                  <div class="form-row">
                      <label><span data-i18n="editor.AEDescription"></span></label>
                      <textarea style="width: 300px" id="AnEDescription[0]" rows="2"></textarea>
                  </div>
              </div>
          </div>
          <!-- Addボタン -->
          <div class="form-block">
            <input type="button" id="form_add" data-i18n="[value]editor.add">
          </div>
          <br>
        </div>
        <!-- tab2 ends -->
    </div>

</script>

<script type="text/x-red" data-help-name="tmp-ctrl-omron-AE">
    <p>preparing ia-cloud objects for store to CCS</p>

<h3>Inputs</h3>
<dl class="message-properties">
  TBD
</dl>

<h3>Outputs</h3>
  <dl class="message-properties">
  TBD
  </dl>

<h3>Details</h3>
  <dl class="message-properties">
  TBD
  </dl>
</script>

<script type="text/javascript">

  RED.nodes.registerType('tmp-ctrl-omron-AE',{
    category: 'iaCloud',
    color:"rgb(231, 180, 100)",
    defaults: {
        name: {value:"tmp-ctrl-omron-AE"},
        confsel: {value:"ui-config", required: true},
        configJson: {value:"", required: true},
        ModbusCom: {value:"", type:"Modbus-com", required: true},
        configReady: {value: "", required: true}
    },
    inputs:1,
    outputs:1,
    icon: "ia-cloud.png",  //アイコンはTBD
    label: function() {
        return this.name||this._("Plc-object");
    },
    labelStyle: function() {
        return this.name?"node_label_italic":"";
    },
    oneditprepare: function() {

        // データItemの数を保持する変数
        var frm_cnt = 0;

        // 設定データを取り出して、各formに展開する。
        if ($("#node-input-configJson").val()) {

          try{ var conf = JSON.parse($("#node-input-configJson").val());}
          catch(e){ conf = null; }
        }
        //設定データがあったら
        if(conf) {
          $("#storeInterval").val(conf[0].options.storeInterval);
          $("#storeAsync").prop("checked", conf[0].options.storeAsync);
          $("#objectName").val(conf[0].objectName);
          $("#objectKey").val(conf[0].objectKey);
          $("#objectDescription").val(conf[0].objectDescription);

          $("contentType").val(conf[0].ObjectContent.contentType);
          var dItems = conf[0].ObjectContent.contentData;

          //フォームを一つ保存
          var original = $('#AnE_block\\[0\\]');

          //一旦フォームオブジェクトをすべて削除
          $(".form-block[id^='AnE_block']")
              .each(function(index, formObj) {$(formObj).remove();});

          dItems.forEach(function(value, idx){
              original
              .clone()
              .hide()
              .appendTo("#blocks")
              .attr('id', 'AnE_block[' + idx + ']') // クローンのid属性を変更。
              .end() // 一度適用する
              .find('div, input, select, textarea, label').each(function(index, obj) {
                if ($(obj).attr('id') != null) {
                  if($(obj).attr("id").substr(0,7) == "AnEItem"){
                      $(obj).val("" + (idx + 1));
                  }
                  $(obj).attr({
                    id: $(obj).attr('id').replace(/\[[0-9]+\]$/, '[' + idx + ']')
                  });
                }
                if ($(obj).attr('for') != null) {
                  $(obj).attr({
                      for: $(obj).attr('for').replace(/\[[0-9]+\]$/, '[' + idx + ']')
                  });
                }
              });
              $("#AnECode\\[" + idx + "\\]").val(value.dataValue.AnECode);
              $("#AnEDescription\\[" + idx + "\\]").val(value.dataValue.AnEDescription);
              $("#dataSelect\\[" + idx + "\\]").val(value.options.source);

              var block = $('#AnE_block\\[' + idx + '\\]');
              if (idx != 0) block.find('input[id^="del_btn"]').show();
              block.slideDown('slow');
              frm_cnt = idx;
          });
        }

        //追加ボタンが押されたら
        $("#form_add").off("click");
        $("#form_add").on("click", function() {
          var original = $('#AnE_block\\[' + frm_cnt + '\\]');
          frm_cnt++;
          original
          .clone()
          .hide()
          .insertAfter(original)
          .attr('id', 'AnE_block[' + frm_cnt + ']'); // クローンのid属性を変更。
          var clone = $('#AnE_block\\[' + frm_cnt + '\\]');
          clone.find('div, input, textarea, select, label').each(function(idx, obj) {
            if ($(obj).attr('id') != null) {
              if($(obj).attr("id").substr(0,7) == "AnEItem"){
                  $(obj).val("" + (frm_cnt + 1));
              }
              $(obj).attr({
                id: $(obj).attr('id').replace(/\[[0-9]+\]$/, '[' + frm_cnt + ']')
              });
            }
            if ($(obj).attr('for') != null) {
              $(obj).attr({
                for: $(obj).attr('for').replace(/\[[0-9]+\]$/, '[' + frm_cnt + ']')
              });
            }
          });
          clone.find('input[id^="del_btn"]').show();
          clone.find('select[id^="dataSelect"]').val(original.find('select[id^="dataSelect"]').val());
          clone.slideDown('fast');
        });

        //削除ボタンが押されたら
        $("#blocks").off('click', 'input[id^="del_btn"]');
        $("#blocks").on('click', 'input[id^="del_btn"]', function() {
          var removeObj = $(this).parents(".form-block");
          removeObj.fadeOut('fast', function() {
            removeObj.remove();
            // 番号振り直し
            frm_cnt = 0;
            $(".form-block[id^='AnE_block']").each(function(index, formObj) {
              if ($(formObj).attr('id') != 'AnE_block[0]') {
                frm_cnt++;
                $(formObj)
                  .attr('id', 'AnE_block[' + frm_cnt + ']') // id属性を変更。
                  .find('div, input, select, label').each(function(idx, obj) {
                   if ($(obj).attr('id') != null) {
                      if($(obj).attr("id").substr(0,7) == "AnEItem"){
                            $(obj).val("" + (frm_cnt + 1));
                      }
                      $(obj).attr({
                        id: $(obj).attr('id').replace(/\[[0-9]+\]$/,'['+frm_cnt+']')
                      });
                    }
                    if ($(obj).attr('for') != null) {
                      $(obj).attr({
                        for: $(obj).attr('for').replace(/\[[0-9]+\]$/,'['+frm_cnt+']')
                      });
                    }
                  });
              }
            });
          });
        });
    },

    oneditsave: function() {
      var configReady = "ready";
      // UI-configの場合
      if (!$("#objectKey").val()) configReady = "";
      // データ設定を作成
      var dItems = [];
      $(".form-block[id^='AnE_block']").each(function(idx, obj){
        var item ={
            commonName: "Alarm&Event",
            dataValue: {},
            options:{}
        };
        item.dataValue.AnEStatus = "";
        item.dataValue.AnECode = $("#AnECode\\[" + idx + "\\]").val();
        item.dataValue.AnEDescription = $("#AnEDescription\\[" + idx + "\\]").val();
        item.options.source = $("#dataSelect\\[" + idx + "\\]").val();
        if (!item.options.source) configReady = "";

        dItems[idx]=item;
      });
      // オブジェクト設定を追加
      var cfgobj = [{ObjectContent:{}, options:{}}];
      cfgobj[0].ObjectContent.contentType = $("#contentType").val();
      cfgobj[0].ObjectContent.contentData = dItems;
      cfgobj[0].objectKey = $("#objectKey").val();
      cfgobj[0].objectDescription = $("#objectDescription").val();
      cfgobj[0].objectName = $("#objectName").val();
      cfgobj[0].options.storeInterval = $("#storeInterval").val();
      cfgobj[0].options.storeAsync = $("#storeAsync").is(":checked");
      $("#node-input-configReady").val(configReady);
      //フォームの各要素をobjectに記述し、JSON文字列に変換する。
      try {$("#node-input-configJson").val(JSON.stringify(cfgobj));}
      catch(e) {$("#node-input-configJson").val("");}

      // 設定完了フラグをセット
      $("#node-input-configReady").val(configReady);
    }
  });

</script>